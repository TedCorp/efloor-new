<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mall.web.mapper.admin.OrderMgrMapper">	
	<!-- 공통 where 조건 -->
	<sql id="searchCondition">
		<where>
		  	<if test='schGbn == "SEARCH_ORDER_NUM"'>
				<if test="schTxt != null and schTxt != ''">
				     AND ORDER_NUM LIKE '%'||#{schTxt}||'%'
				</if>	
			</if>
			<if test='schGbn == "MEMB_NM"'>
				<if test="schTxt != null and schTxt != ''">
				     AND MEMB_NM LIKE '%'||#{schTxt}||'%'
				</if>	
			</if>		
			<if test='schGbn == "RECV_PERS"'>
				<if test="schTxt != null and schTxt != ''">
				    AND RECV_PERS LIKE '%'||#{schTxt}||'%'
				</if>	
			</if>
			<if test='schGbn == "COM_NAME"'>
				<if test="schTxt != null and schTxt != ''">
				    AND COM_NAME LIKE '%'||#{schTxt}||'%'
				</if>	
			</if>
			<if test="ORDER_CON != null and ORDER_CON != ''">
			    AND ORDER_CON = #{ORDER_CON}
			</if>	
			<!-- <if test="ORDER_CON == null or ORDER_CON == ''">
			    AND NOT ORDER_CON IN ('ORDER_CON_04','ORDER_CON_07','ORDER_CON_08','ORDER_CON_11')
			</if> -->
			<if test="PAY_METD != null and PAY_METD != ''">
			    AND PAY_METD = #{PAY_METD}
			</if>
			<if test="datepickerStr != null and datepickerStr != ''">
				AND TO_CHAR(TO_DATE(ORDER_DATE,'YYYY-MM-DD HH24:MI:SS'),'YYYY-MM-DD') <![CDATA[>=]]> #{datepickerStr}
			</if>
			<if test="datepickerEnd != null and datepickerEnd != ''">
				AND TO_CHAR(TO_DATE(ORDER_DATE,'YYYY-MM-DD HH24:MI:SS'),'YYYY-MM-DD') <![CDATA[<=]]> #{datepickerEnd}
			</if>
		</where>  
	</sql>
	<sql id="orderByCondition">
		<if test="ORDER_GUBUN != null and ORDER_GUBUN != ''">
			<if test='ORDER_GUBUN == "DATE_ORDER"'>
				<if test='DATE_ORDER == "desc"'>
					ORDER BY ORDER_DATE desc
				</if>	
				<if test='DATE_ORDER == "asc"'>
					ORDER BY ORDER_DATE asc
				</if>	
			</if>
			<if test='ORDER_GUBUN == "MEMB_NM_ORDER"'>
				<if test='MEMB_NM_ORDER == "desc"'>
					ORDER BY MEMB_NM desc, ORDER_NUM ASC
				</if>	
				<if test='MEMB_NM_ORDER == "asc"'>
					ORDER BY MEMB_NM asc, ORDER_NUM ASC
				</if>
			</if>
			<if test='ORDER_GUBUN == "COM_NAME_ORDER"'>
				<if test='MEMB_NM_ORDER == "desc"'>
					ORDER BY COM_NAME desc nulls last, ORDER_NUM ASC
				</if>	
				<if test='MEMB_NM_ORDER == "asc"'>
					ORDER BY COM_NAME asc, ORDER_NUM ASC
				</if>
			</if>
			<if test='ORDER_GUBUN == "PAY_DATE_ORDER"'>
				<if test='PAY_DATE_ORDER == "desc"'>
					ORDER BY PAY_DTM desc nulls last, ORDER_NUM ASC
				</if>	
				<if test='PAY_DATE_ORDER == "asc"'>
					ORDER BY PAY_DTM asc, ORDER_NUM ASC
				</if>
			</if>
			<if test='ORDER_GUBUN == "DLAR_DATE_ORDER"'>
				<if test='DLAR_DATE_ORDER == "desc"'>
					ORDER BY DLAR_DATE desc, DLAR_TIME ASC, ORDER_NUM ASC
				</if>	
				<if test='DLAR_DATE_ORDER == "asc"'>
					ORDER BY DLAR_DATE asc, DLAR_TIME ASC, ORDER_NUM ASC
				</if>
			</if>				
		</if>
		<if test="ORDER_GUBUN == null or ORDER_GUBUN == ''">
			ORDER BY ORDER_DATE desc, ORDER_NUM ASC
		</if>
	</sql>
	
	<!-- 주문목록 카운트 -->
	<select id="count" parameterType="mall.web.domain.TB_ODINFOXM" resultType="int">
		SELECT count(*)
	      FROM (
	         SELECT  INFO.*, MEM.COM_NAME
	         FROM (
	            SELECT A.ORDER_NUM                        /*주문번호*/
	           		      ,A.ORDER_DATE                        /*주문일자*/
	          		      ,A.MEMB_ID                        /*회원ID (주문자)*/
	          		       ,POLARBEAR.FC_GET_MEMBID_NM(A.MEMB_ID) AS MEMB_NM   /*회원ID명(주문자)*/
	          		       ,C.RECV_PERS                        /*수령인*/
	           		      ,A.ORDER_AMT                        /*주문금액*/
	           		      ,A.ORDER_CON                        /*주문상태*/
	           		      ,A.PAY_METD                        /*결제수단*/
	           		      ,POLARBEAR.FC_GET_ORDER_SUPRID(A.ORDER_NUM, #{MEMB_ID}) AS ISCHECK
	            FROM POLARBEAR.TB_ODINFOXM A
	            LEFT OUTER JOIN POLARBEAR.TB_ODDLAIXM C
	               ON A.ORDER_NUM = C.ORDER_NUM
	            WHERE 1=1
	              AND DEL_YN IS NULL OR DEL_YN = 'N'                
	         ) INFO
	         LEFT OUTER JOIN POLARBEAR.TB_MBINFOXM MEM
	            ON INFO.MEMB_ID = MEM.MEMB_ID
	         WHERE ISCHECK ='Y'
	      )
	</select>
	
	<!-- 주문 목록 -->
	<select id="paginatedList" parameterType="mall.web.domain.TB_ODINFOXM" resultType="mall.web.domain.TB_ODINFOXM">
	<include refid="default.pagerHeader"/>	
  	SELECT *
		FROM (
			SELECT	INFO.*
						, MEM.COM_NAME
						, MEM.ADM_REF
						, P.PAYMENT AS PPAYMENT
						, O.PAYMENT AS OPAYMENT
						, P.PNUM AS PPNUM
						, P.DEDUCTIONORPROOFBUSINESS
						, P.COMPUNYNUM AS COMPUNYNUM_CASHRECEIPT
						, O.INVOICEECORPNAME AS INVOICEECORPNAME_TAXINVOICE
						, O.INVOICEECORPNUM AS INVOICEECORPNUM_TAXINVOICE
						, CASE #{MEMB_GUBN} 
						  WHEN 'MEMB_GUBN_04' THEN ( SELECT SUM(SUPR_AMT)
														FROM ( SELECT  B.SUPR_ID                                                               
						 								             , A.DLVR_INDI_YN                                                             
															         , A.DLVY_SORT
															         , C.ORDER_NUM 
															         , CASE A.DLVY_SORT WHEN 'PRICE_DESC' THEN MAX(C.DLVY_AMT) ELSE MIN(C.DLVY_AMT) END AS SUPR_AMT    
															   FROM POLARBEAR.TB_PDINFOXM A, POLARBEAR.TB_MBINFOXM B, POLARBEAR.TB_ODINFOXD C
															   WHERE A.SUPR_ID = B.SUPR_ID
															    AND A.PD_CODE = C.PD_CODE
															    AND A.PD_CODE = C.SETPD_CODE
															    AND B.SUPR_ID=#{LOGIN_SUPR_ID}
															    AND C.ORDER_NUM =INFO.ORDER_NUM
															 GROUP BY B.SUPR_ID, A.DLVR_INDI_YN, A.DLVY_SORT, C.ORDER_NUM) G)
						ELSE INFO.DLVY_AMT 
						END AS DLVY_AMT_REAL
					  , CASE #{MEMB_GUBN}
					  <!-- 새로 계산된 배송비 가져오기 -->
					  <!-- 공급사일 경우 -->
					  	WHEN 'MEMB_GUBN_04' THEN ( SELECT CASE WHEN sum(SUPR_AMT) IS NULL THEN 0 ELSE sum(SUPR_AMT) END AS SUPR_AMT
												   FROM (
												          SELECT  B.SUPR_ID																					
															     , A.DLVR_INDI_YN																				 
															     , A.DLVY_SORT																					 
															     , CASE A.DLVY_SORT WHEN 'PRICE_DESC' THEN MAX(C.IMSI_DLVY_AMT) ELSE MIN(C.IMSI_DLVY_AMT) END AS SUPR_AMT
													     FROM POLARBEAR.TB_PDINFOXM A, POLARBEAR.TB_SPINFOXM B, 
													         (SELECT 
													                ORDER_NUM
													              , REGP_ID
													              , PD_CODE
													              , IMSI_DLVY_AMT
													              , ORDER_CON
													              , SUPR_ID
													              , POLARBEAR.FC_GET_PD_TYPE(ORDER_NUM ,ORDER_DTNUM) AS PRD_TYPE 
													          FROM POLARBEAR.TB_ODINFOXD) C
													     WHERE A.SUPR_ID = B.SUPR_ID
													     AND A.PD_CODE = C.PD_CODE
														 AND C.PRD_TYPE != '추가상품'
														 AND C.SUPR_ID=#{LOGIN_SUPR_ID}
														 AND C.ORDER_NUM = INFO.ORDER_NUM
														 AND (C.ORDER_CON != 'ORDER_CON_04' AND C.ORDER_CON != 'ORDER_CON_07')
													     GROUP BY B.SUPR_ID, A.DLVR_INDI_YN, A.DLVY_SORT))
					  <!-- 공급사가 아닐 경우 -->
						  ELSE (SELECT CASE WHEN sum(SUPR_AMT) IS NULL THEN 0 ELSE sum(SUPR_AMT) END AS SUPR_AMT
							   FROM (
							          SELECT  B.SUPR_ID																					
										     , A.DLVR_INDI_YN																				 
										     , A.DLVY_SORT																					 
										     , CASE A.DLVY_SORT WHEN 'PRICE_DESC' THEN MAX(C.IMSI_DLVY_AMT) ELSE MIN(C.IMSI_DLVY_AMT) END AS SUPR_AMT
								     FROM POLARBEAR.TB_PDINFOXM A, POLARBEAR.TB_SPINFOXM B, 
								         (SELECT 
								                ORDER_NUM
								              , REGP_ID
								              , PD_CODE
								              , IMSI_DLVY_AMT
								              , ORDER_CON
								              , SUPR_ID
								              , POLARBEAR.FC_GET_PD_TYPE(ORDER_NUM ,ORDER_DTNUM) AS PRD_TYPE 
								          FROM POLARBEAR.TB_ODINFOXD) C
								     WHERE A.SUPR_ID = B.SUPR_ID
								     AND A.PD_CODE = C.PD_CODE
									 AND C.PRD_TYPE != '추가상품'
									 AND C.ORDER_NUM = INFO.ORDER_NUM
									 AND (C.ORDER_CON != 'ORDER_CON_04' AND C.ORDER_CON != 'ORDER_CON_07')
								     GROUP BY B.SUPR_ID, A.DLVR_INDI_YN, A.DLVY_SORT))
						  END AS DLVY_AMT_NEW
			FROM (
				SELECT	A.ORDER_NUM			
				     	, TO_CHAR( TO_DATE( ORDER_DATE, DECODE(LENGTH(ORDER_DATE), 8, 'YYYYMMDD', 'YYYYMMDDHH24MISS')), 
				     				DECODE(LENGTH(ORDER_DATE), 8, 'yyyy-MM-dd', 'yyyy-MM-dd HH24:mi:SS')) AS ORDER_DATE																											/*주문일자*/
						, A.MEMB_ID	
						, A.DLVY_AMT
						, (SELECT MEMB_NAME FROM POLARBEAR.TB_MBINFOXM WHERE MEMB_ID = A.MEMB_ID) AS MEMB_NM		/*회원명*/
						, C.RECV_PERS    																											/*수령인*/
						, POLARBEAR.FC_GET_REFUND_ORDER_PD(A.ORDER_NUM, #{MEMB_ID}) AS PD_NAME
						, POLARBEAR.FC_GET_TOTORDERAMT(A.ORDER_NUM, #{MEMB_ID}) AS ORDER_AMT   																											/*주문금액*/
						, POLARBEAR.FC_GET_ORDSTATUS(A.ORDER_NUM, #{MEMB_ID}) AS ORDER_CON								        																		/*주문상태*/
						, POLARBEAR.FC_GET_COMCOD_NM(POLARBEAR.FC_GET_ORDSTATUS(A.ORDER_NUM, #{MEMB_ID})) AS ORDER_CON_NM    				/*주문상태 명*/
						, POLARBEAR.FC_GET_CANCEL_ORDER_AMT(A.ORDER_NUM, #{MEMB_ID}) AS TOTAL_CANCEL
						, A.PAY_METD																													/*결제수단*/
						, (SELECT POLARBEAR.FC_GET_COMCOD_NM(A.PAY_METD) FROM DUAL) AS PAY_METD_NM      					/*결제수단 명*/
						, (SELECT COUNT(*)-1 FROM POLARBEAR.TB_ODINFOXD WHERE ORDER_NUM = A.ORDER_NUM) AS count 	/*주문 제품 갯수*/
						, A.ORDER_DTM																												/*주문일시*/
						, A.PAY_DTM																													/*결제일시*/
						, DECODE(C.DLAR_GUBN,'DLAR_GUBN_05','현장출고','직배송요청') AS DLAR_GUBN 							/*출고방식*/
						, C.DLVY_MSG    																												/*배송메세지*/
						, DECODE( LENGTH(C.DLAR_DATE), 8, TO_CHAR(TO_DATE(C.DLAR_DATE,'YYYYMMDD'), 'YYYY-MM-DD'), '') || ' '|| C.DLAR_TIME AS DLAR_DATE_TIME   /*출고 시간*/
						, C.DLAR_DATE
						, DECODE(C.DLAR_TIME, '오전', 1, '오후', 2, '', 4, 3) AS DLAR_TIME
						, A.CPON_YN
						, A.DLVY_TDN
						, A.REGP_ID
						, A.REG_DTM
						, A.MODP_ID
						, A.MOD_DTM
						, (SELECT sum(RFND_DLVY_AMT) FROM POLARBEAR.TB_ODINFOXD WHERE ORDER_NUM =A.ORDER_NUM)AS RFND_DLVY_AMT
				FROM POLARBEAR.TB_ODINFOXM A      					/*주문마스터*/					 
				LEFT OUTER JOIN POLARBEAR.TB_ODDLAIXM C			/*배송지정보*/
					ON A.ORDER_NUM = C.ORDER_NUM
				WHERE 1=1
					AND A.PAY_MDKY IS NOT NULL
					AND (DEL_YN IS NULL OR DEL_YN = 'N')				
				    AND POLARBEAR.FC_GET_ORDER_SUPRID(A.ORDER_NUM, #{MEMB_ID}) = 'Y'
			) INFO
			LEFT OUTER JOIN POLARBEAR.TB_MBINFOXM MEM ON INFO.MEMB_ID = MEM.MEMB_ID
	        LEFT OUTER JOIN POLARBEAR.TB_ODTAXINFO_CASHRECEIPT P ON INFO.ORDER_NUM = P.ORDER_NUM 
	        LEFT OUTER JOIN POLARBEAR.TB_ODTAXINFO_TAXINVOICE O ON INFO.ORDER_NUM = O.ORDER_NUM
       	)
  	
  	
  	<!-- 	SELECT *
		FROM (
			SELECT	INFO.*, MEM.COM_NAME, MEM.ADM_REF
			FROM (
				SELECT	A.ORDER_NUM																											/*주문번호*/
				     	, TO_CHAR( TO_DATE( ORDER_DATE, DECODE(LENGTH(ORDER_DATE), 8, 'YYYYMMDD', 'YYYYMMDDHH24MISS')), DECODE(LENGTH(ORDER_DATE), 8, 'yyyy-MM-dd', 'yyyy-MM-dd HH24:mi:SS')) AS ORDER_DATE																											/*주문일자*/
						, A.MEMB_ID								  																					/*회원ID*/
						, (SELECT MEMB_NAME FROM TB_MBINFOXM WHERE MEMB_ID = A.MEMB_ID) AS MEMB_NM		/*회원명*/
						, C.RECV_PERS    																											/*수령인*/
						, FC_GET_REFUND_ORDER_PD(A.ORDER_NUM,  #{MEMB_ID}) AS PD_NAME
						, FC_GET_TOTORDERAMT(A.ORDER_NUM, #{MEMB_ID}) AS ORDER_AMT   																											/*주문금액*/
						, FC_GET_ORDSTATUS(	A.ORDER_NUM, #{MEMB_ID}) AS ORDER_CON								        																		/*주문상태*/
						, FC_GET_COMCOD_NM(FC_GET_ORDSTATUS(	A.ORDER_NUM, #{MEMB_ID})) AS ORDER_CON_NM    				/*주문상태 명*/
						, FC_GET_CANCEL_ORDER_AMT(A.ORDER_NUM, #{MEMB_ID}) AS TOTAL_CANCEL
						, A.PAY_METD																													/*결제수단*/
						, (SELECT FC_GET_COMCOD_NM(A.PAY_METD) FROM DUAL) AS PAY_METD_NM      					/*결제수단 명*/
						, (SELECT COUNT(*)-1 FROM TB_ODINFOXD WHERE ORDER_NUM = A.ORDER_NUM) AS count 	/*주문 제품 갯수*/
						, A.ORDER_DTM																												/*주문일시*/
						, A.PAY_DTM																													/*결제일시*/
						, FC_GET_DLVPRICE(A.ORDER_NUM, #{MEMB_ID}) AS DLVY_AMT									/*배송료*/
						, DECODE(C.DLAR_GUBN,'DLAR_GUBN_05','현장출고','직배송요청') AS DLAR_GUBN 							/*출고방식*/
						, C.DLVY_MSG    																												/*배송메세지*/
						, DECODE( LENGTH(C.DLAR_DATE), 8, TO_CHAR(TO_DATE(C.DLAR_DATE,'YYYYMMDD'), 'YYYY-MM-DD'), '') || ' '|| C.DLAR_TIME AS DLAR_DATE_TIME   /*출고 시간*/
						, C.DLAR_DATE
						, DECODE(C.DLAR_TIME, '오전', 1, '오후', 2, '', 4, 3) AS DLAR_TIME
						, A.CPON_YN
						, A.DLVY_TDN
						, A.REGP_ID
						, A.REG_DTM
						, A.MODP_ID
						, A.MOD_DTM
						, (SELECT sum(RFND_DLVY_AMT) FROM TB_ODINFOXD WHERE ORDER_NUM =A.ORDER_NUM)AS RFND_DLVY_AMT
				FROM TB_ODINFOXM A      					/*주문마스터*/					 
				LEFT OUTER JOIN TB_ODDLAIXM C			/*배송지정보*/
					ON A.ORDER_NUM = C.ORDER_NUM
				WHERE 1=1
					AND A.PAY_MDKY IS NOT NULL
					AND (DEL_YN IS NULL OR DEL_YN = 'N')				
				    AND FC_GET_ORDER_SUPRID(A.ORDER_NUM, #{MEMB_ID}) = 'Y'
			) INFO
	        LEFT OUTER JOIN TB_MBINFOXM MEM
	        	ON INFO.MEMB_ID = MEM.MEMB_ID
       	)    	 -->
		<include refid="searchCondition"/>
		<include refid="orderByCondition"/>
	<include refid="default.pagerFooter"/>
	</select>
	
	<!-- 주문정보 마스터 정보 - 상세화면 -->
	<select id="getMasterInfo" parameterType="mall.web.domain.TB_ODINFOXM" resultType="mall.web.domain.TB_ODINFOXM">
		SELECT A.ORDER_NUM																	/*주문번호*/
			  ,TO_CHAR(TO_DATE(A.ORDER_DATE
				      ,DECODE(LENGTH(A.ORDER_DATE),8,'YYYYMMDD','YYYYMMDDHH24MISS'))
				      ,DECODE(LENGTH(A.ORDER_DATE),8,'yyyy-MM-dd','yyyy-MM-dd HH24:mi:SS')
			  ) AS ORDER_DATE																/*주문일자*/
			, A.ORDER_DTM																	/*주문일시*/
			, A.MEMB_ID																		/*주문자ID*/
			, M.MEMB_NAME AS MEMB_NM														/*회원명*/
			, M.MEMB_CPON																	/*회원연락처*/
			, A.ORDER_AMT																	/*주문금액*/
			, A.ORDER_CON																	/*주문상태*/
			, (SELECT POLARBEAR.FC_GET_COMCOD_NM(A.ORDER_CON) FROM DUAL) AS ORDER_CON_NM				/*주문상태 명*/
			, A.PAY_METD																	/*결제수단*/
			, (SELECT POLARBEAR.FC_GET_COMCOD_NM(A.PAY_METD) FROM DUAL) AS PAY_METD_NM				/*결제수단 명*/
			, A.DAP_YN																		/*배송비결재여부*/
			, A.DLVY_CON																	/*배송상태*/
			, (SELECT POLARBEAR.FC_GET_COMCOD_NM(A.DLVY_CON) FROM DUAL) AS DLVY_CON_NM				/*배송상태 명*/
			, A.DLVY_COM																	/*배송업체*/
			, (SELECT POLARBEAR.FC_GET_COMCOD_NM(A.DLVY_COM) FROM DUAL) AS DLVY_COM_NM				/*배송업체 명*/
			, A.DLVY_TDN																	/*배송운송장번호*/
			, A.CNCL_CON																	/*취소상태*/
			, (SELECT POLARBEAR.FC_GET_COMCOD_NM(A.CNCL_CON) FROM DUAL) AS CNCL_CON_NM				/*취소상태 명*/
			, A.CNCL_MSG																	/*취소환불사유*/
			, A.RFND_CON																	/*환불상태*/
			, (SELECT POLARBEAR.FC_GET_COMCOD_NM(A.RFND_CON) FROM DUAL) AS RFND_CON_NM				/*환불상태 명*/
			, A.RFND_MSG																	/*환불사유*/
			, (SELECT POLARBEAR.FC_GET_COMCOD_NM(A.RFND_MSG) FROM DUAL) AS RFND_MSG_NM				/*환불사유 명*/
			, A.RFND_RMK																	/*환불거절사유*/							
			, A.PAY_DTM																		/*결제일시*/
			, A.ORIGIN_NUM																	/*원 주문번호*/
			, A.CPON_YN																		/*쿠폰사용여부*/
			, M.COM_BUNB																	/*사업자번호*/
			, A.PAY_MDKY
			, A.DLVY_AMT 																	/*배송비*/
			, A.RFND_AMT																	/*취소금액*/
		FROM POLARBEAR.TB_ODINFOXM A
		INNER JOIN POLARBEAR.TB_MBINFOXM M
		   ON A.MEMB_ID = M.MEMB_ID
		WHERE ORDER_NUM = #{ORDER_NUM}
	</select>
	
	<!-- 주문정보 상세   -->
	<select id="getDetailsList" parameterType="mall.web.domain.TB_ODINFOXM" resultType="mall.web.domain.TB_ODINFOXD">
		SELECT ORDER_DTNUM
		     , ORDER_NUM
		     , PD_CODE
		     , POLARBEAR.FC_GET_ORDER_PD_NM(ORDER_NUM,PD_CODE,ORDER_DTNUM)  AS PD_NAME 
			 , OPTION1_VALUE
			 , OPTION2_VALUE
			 , OPTION3_VALUE  
		     , PDDC_GUBN
		     , PDDC_VAL
		     , PD_PRICE
		     , ORDER_QTY
		     , ORDER_AMT
			 , POLARBEAR.FC_GET_DLVPRICE_SUPR(A.ORDER_NUM, SUPR_ID) AS DLVY_AMT   
             , SUPR_ID
             , ORDER_CON
             , DLVY_CON
             , DLVY_TDN
			 , RFND_CON
             , CASE
					WHEN A.PDDC_GUBN = 'PDDC_GUBN_02' THEN A.PD_PRICE - A.PDDC_VAL
					WHEN A.PDDC_GUBN = 'PDDC_GUBN_03' THEN A.PD_PRICE - (A.PD_PRICE * (A.PDDC_VAL/100))
					ELSE A.PD_PRICE
			   END REAL_PRICE
		     , (SELECT CUT_UNIT FROM POLARBEAR.TB_PDCUTXM WHERE PD_CODE = A.PD_CODE AND SEQ = PD_CUT_SEQ ) PD_CUT_SEQ
		     , NVL(
		     	(SELECT COMDCD_NAME FROM POLARBEAR.TB_COMCODXD WHERE COMM_CODE = 'OPTION_GUBN' AND COMD_CODE = A.OPTION_CODE ),
                (SELECT OPTDCD_NAME FROM POLARBEAR.TB_OPTCODXD M, POLARBEAR.TB_PDINFOXM N  WHERE M.OPTD_CODE = A.OPTION_CODE AND N.PD_CODE = A.PD_CODE AND M.OPTM_CODE = N.OPTION_GUBN)
               ) AS OPTION_CODE
             , (SELECT PS_COM FROM POLARBEAR.TB_SPINFOXM WHERE A.SUPR_ID=SUPR_ID) AS DLVY_COM
             , (SELECT POLARBEAR.FC_GET_COMCOD_NM(PS_COM) FROM POLARBEAR.TB_SPINFOXM WHERE A.SUPR_ID=SUPR_ID) AS DLVY_COM_NAME
             , LINK_ORDER_KEY
             , POLARBEAR.FC_GET_CANCEL_ORDER_AMT_SUPR(A.ORDER_NUM, A.SUPR_ID) AS TOTAL_CANCEL
             , RFND_AMT
			 , RFND_DLVY_AMT
			 , SETPD_CODE
			FROM POLARBEAR.TB_ODINFOXD A
				WHERE ORDER_NUM = #{ORDER_NUM}
				 AND POLARBEAR.FC_GET_ORDER_SUPRID(ORDER_NUM, #{MEMB_ID}) = 'Y'
		   			<if test='MEMB_GUBN != "MEMB_GUBN_03" '>
		   					AND A.SUPR_ID=#{LOGIN_SUPR_ID}
		 			</if> 
		 		ORDER BY ORDER_DTNUM  desc 
	</select>
	
	<!-- 배송지 정보 - 상세화면 -->
	<select id="getDeliveryInfo" parameterType="mall.web.domain.TB_ODINFOXM" resultType="mall.web.domain.TB_ODDLAIXM">
		SELECT A.ORDER_NUM			/*주문번호*/
			 , A.DLAR_GUBN			/*배송지구분*/
			 , A.RECV_PERS			/*수령인*/
			 , A.POST_NUM			/*우편번호*/
			 , A.BASC_ADDR			/*기본주소*/
			 , A.DTL_ADDR			/*상세주소*/
			 , A.RECV_TELN			/*수령인 전화번호*/
			 , A.RECV_CPON			/*수령인 휴대전화*/
			 , A.DLVY_MSG			/*배송메세지*/
			 , M.ADM_REF			/*관리자설명참조*/
			 , A.DLAR_DATE			/* 출고일 */
			 , A.DLAR_TIME			/* 배송시간/출고시간 */
			 , M.MEMB_ID
		FROM POLARBEAR.TB_ODDLAIXM A
		INNER JOIN POLARBEAR.TB_ODINFOXM B
			ON A.ORDER_NUM = B.ORDER_NUM
		INNER JOIN POLARBEAR.TB_MBINFOXM M
			ON B.MEMB_ID = M.MEMB_ID
		WHERE A.ORDER_NUM = #{ORDER_NUM}		   
	</select>
	
	<!-- 일괄상태변경 -->
	<update id="updateState" parameterType="mall.web.domain.TB_ODINFOXM">
		UPDATE
			POLARBEAR.TB_ODINFOXM
		SET  
			 ORDER_CON = #{ORDER_CON_STATE}
			,MODP_ID = #{MODP_ID}
		    ,MOD_DTM = SYSDATE
		WHERE ORDER_NUM = #{ORDER_NUM}
	</update>
	
	<!-- 일괄상태변경 -->
	<update id="ordState" parameterType="mall.web.domain.TB_ODINFOXM">
		UPDATE
			POLARBEAR.TB_ODINFOXM
		SET  
			 ORDER_CON = #{ORDER_CON}
			,MODP_ID = #{MODP_ID}
		    ,MOD_DTM = SYSDATE
		    <if test="PAY_METD != null and PAY_METD != '' and PAY_METD == 'SC0040' and ORDER_CON == 'ORDER_CON_02'">
		    ,PAY_DTM = SYSDATE
		    </if>
		WHERE
			ORDER_NUM = #{ORDER_NUM}
			<if test="PAY_METD != null and PAY_METD != ''">
		    AND PAY_METD = #{PAY_METD}
		    </if>
	</update>

	<!-- 공급사 가격 가져오기  - 이유리 -->
	<select id="suprProductAmt" parameterType="mall.web.domain.TB_ODINFOXM" resultType="mall.web.domain.TB_ODINFOXM">
	   SELECT count(SETPD_CODE) AS CNT
		     , sum(ORDER_AMT) AS SUPR_AMT
		     , SETPD_CODE
		FROM POLARBEAR.TB_ODINFOXD
		WHERE ORDER_NUM = #{ORDER_NUM}
		  AND (ORDER_CON != 'ORDER_CON_04' AND ORDER_CON != 'ORDER_CON_07')
		GROUP BY SETPD_CODE
	</select>
	
	<!-- 배송비 변경  - 이유리 -->
	<update id="updateDlvyAmt" parameterType="mall.web.domain.TB_ODINFOXD">
		UPDATE
			POLARBEAR.TB_ODINFOXD
		SET
			IMSI_DLVY_AMT = #{DLVY_AMT}
		WHERE
			ORDER_NUM = #{ORDER_NUM}
		AND
			SETPD_CODE = #{SETPD_CODE}
	</update>
	
	<!-- 새 배송비 가져오기  - 이유리 -->
	<select id="newDlvyAmt" parameterType="mall.web.domain.TB_ODINFOXM" resultType="int">
	 SELECT CASE WHEN sum(SUPR_AMT) IS NULL THEN 0 ELSE sum(SUPR_AMT) END AS SUPR_AMT
	   FROM (
	          SELECT  B.SUPR_ID																					
		     , A.DLVR_INDI_YN																				 
		     , A.DLVY_SORT																					 
		     , CASE A.DLVY_SORT WHEN 'PRICE_DESC' THEN MAX(C.IMSI_DLVY_AMT) ELSE MIN(C.IMSI_DLVY_AMT) END AS SUPR_AMT
		     FROM POLARBEAR.TB_PDINFOXM A, POLARBEAR.TB_SPINFOXM B, 
		         (SELECT 
		                ORDER_NUM
		              , REGP_ID
		              , PD_CODE
		              , IMSI_DLVY_AMT
		              , ORDER_CON
		              , POLARBEAR.FC_GET_PD_TYPE(ORDER_NUM ,ORDER_DTNUM) AS PRD_TYPE 
		          FROM POLARBEAR.TB_ODINFOXD) C
		     WHERE A.SUPR_ID = B.SUPR_ID
		     AND A.PD_CODE = C.PD_CODE
			 AND C.PRD_TYPE != '추가상품'
			 AND C.ORDER_NUM = #{ORDER_NUM}
			 AND (C.ORDER_CON != 'ORDER_CON_04' AND C.ORDER_CON != 'ORDER_CON_07')
		     GROUP BY B.SUPR_ID, A.DLVR_INDI_YN, A.DLVY_SORT)
	</select>
	
	<!-- 마스터 주문 수정 - 이유리 -->
	<update id="update" parameterType="mall.web.domain.TB_ODINFOXM">
		UPDATE
			POLARBEAR.TB_ODINFOXM
		SET
			<if test="CNCL_CON != null and CNCL_CON != ''">
			CNCL_CON = #{CNCL_CON},
			CNCL_REQDTM = SYSDATE,
			</if>
			<if test="RFND_CON != null and RFND_CON != ''">
			RFND_CON = #{RFND_CON},
			RFND_REQDTM = SYSDATE,
			</if>
			<if test="RFND_AMT != null and RFND_AMT != ''">
			RFND_AMT = #{RFND_AMT},
			</if>
			MOD_DTM = SYSDATE
		WHERE
			ORDER_NUM = #{ORDER_NUM}
	</update>

	<!-- 주문상태 및 결제 정보 수정 -->
	<update id="getDetailsUpdate" parameterType="mall.web.domain.TB_ODINFOXD">
		UPDATE
			POLARBEAR.TB_ODINFOXD
		SET
			ORDER_CON = #{ORDER_CON} /*주문상태*/
				<choose>
					<when test="ORDER_CON =='ORDER_CON_04' "><!--주문취소로 변경시   CNCL-->
						,CNCL_CON = 'CNCL_CON_03'
					</when>
					<otherwise>
						,CNCL_CON=null
					</otherwise>
				</choose>
				<choose>
					<when test="ORDER_CON =='ORDER_CON_07' "><!-- 환불완료라면-->
						,RFND_CON='RFND_CON_03'
					</when>
					<when test="ORDER_CON =='ORDER_CON_10' "><!-- 환불접수라면 -->
						,RFND_CON='RFND_CON_01'
					</when>
					<when test="ORDER_CON=='ORDER_CON_11'"><!-- 환불거절이라면 -->
							,RFND_CON='RFND_CON_02'
					</when>
					<otherwise>
						,RFND_CON=null
					</otherwise>
				</choose>
			, DLVY_TDN = #{DLVY_TDN}	/*배송운송장번호*/
			, MODP_ID = #{MODP_ID}
			, MOD_DTM = SYSDATE
		 WHERE ORDER_NUM = #{ORDER_NUM}
		 AND PD_CODE = #{PD_CODE}
		 <if test=" OPTION1_VALUE !=  '' and OPTION1_VALUE != null ">
			AND OPTION1_VALUE = #{OPTION1_VALUE}
		</if>
		<if test=' OPTION2_VALUE != "" and OPTION2_VALUE != null '>
			AND OPTION2_VALUE = #{OPTION2_VALUE}
		</if>
		<if test=' OPTION3_VALUE != "" and OPTION3_VALUE != null '>
			AND OPTION3_VALUE = #{OPTION3_VALUE}
		</if>
		<if test='MEMB_GUBN != "MEMB_GUBN_03" '>
		   		AND SUPR_ID=#{LOGIN_SUPR_ID}
		 </if> 
	</update>
	
	
	<!--  기존 getDetailsUpdate
	<update id="getDetailsUpdate" parameterType="mall.web.domain.TB_ODINFOXM">
		UPDATE
			TB_ODINFOXM
		SET
			ORDER_CON = #{ORDER_CON} /*주문상태*/
		      , CNCL_CON = #{CNCL_CON}	/*취소상태*/  
		  	<if test="CNCL_CON != null and CNCL_CON != ''">
			, CNCL_REQDTM = SYSDATE	/*취소 요청일시*/
			</if>	
			<if test="CNCL_CON == null or CNCL_CON == ''">
			, CNCL_REQDTM = ''	/*취소 요청일시*/
			</if> 
			, RFND_CON = #{RFND_CON}	/*환불상태*/
		<if test="RFND_CON != null and RFND_CON != ''">
			, RFND_REQDTM = SYSDATE	/*환불 요청일시*/
			</if>	
			<if test="RFND_CON == null or RFND_CON == ''">
			, RFND_REQDTM = ''	/*환불 요청일시*/
			</if> 
			, PAY_METD = #{PAY_METD}	/*결제수단*/	
			, DLVY_COM = #{DLVY_COM}	/*배송업체*/   
			, DLVY_TDN = #{DLVY_TDN}	/*배송운송장번호*/
			, MODP_ID = #{MODP_ID}
			, MOD_DTM = SYSDATE
	  		<if test='PAY_AMT != null and PAY_AMT!=""'>
			, PAY_AMT = #{PAY_AMT}
			</if>
			<if test='PAY_DTM != null and PAY_DTM!=""'>
			, PAY_DTM = TO_DATE(#{PAY_DTM},'YYYYMMDDHH24MISS') 
			</if>  
		 WHERE ORDER_NUM = #{ORDER_NUM}
	</update>-->
	
	
	<!-- 주문상태 및 결제 정보 수정 -->
	<update id="getUpdateCancel" parameterType="mall.web.domain.TB_ODINFOXD">
		UPDATE
			POLARBEAR.TB_ODINFOXD
		SET
			ORDER_CON = #{ORDER_CON} /*주문취소 상태변경*/
			, CNCL_CON = #{CNCL_CON} /*취소완료 상태변경*/
			, RFND_AMT = #{RFND_AMT}  /*취소금액*/
			, MODP_ID = #{MODP_ID}
			, MOD_DTM = SYSDATE
		 WHERE ORDER_NUM = #{ORDER_NUM}
		 AND PD_CODE = #{PD_CODE}
		 <if test=" OPTION1_VALUE !=  '' and OPTION1_VALUE != null ">
			AND OPTION1_VALUE = #{OPTION1_VALUE}
		</if>
		<if test=' OPTION2_VALUE != "" and OPTION2_VALUE != null '>
			AND OPTION2_VALUE = #{OPTION2_VALUE}
		</if>
		<if test=' OPTION3_VALUE != "" and OPTION3_VALUE != null '>
			AND OPTION3_VALUE = #{OPTION3_VALUE}
		</if>
		<if test='MEMB_GUBN != "MEMB_GUBN_03" '>
		   		AND SUPR_ID=#{LOGIN_SUPR_ID}
		 </if> 
	</update>
	<!-- 마스터 상태 변경 (배송비) :20211221 장보라-->
	<update id="getMasterUpdate" parameterType="mall.web.domain.TB_ODINFOXM">
		UPDATE
			POLARBEAR.TB_ODINFOXM
		SET
			  DLVY_AMT= #{DLVY_AMT} /*배송비*/
			, MODP_ID = #{MODP_ID}
			, MOD_DTM = SYSDATE
		 WHERE ORDER_NUM = #{ORDER_NUM}
	</update>
	
	<!-- 주문 디테일 주문상태 및 결제 정보 수정 (연동) / 2020-02-27 LJS /수정 2020-09-08 JW -->
	<update id="getOrderDetailsUpdate" parameterType="mall.web.domain.TB_ODINFOXD">
		UPDATE
			POLARBEAR.TB_ODINFOXD
		SET
			ORDER_CON = #{ORDER_CON}		/*주문상태*/
		<if test="CNCL_CON != null and CNCL_CON != '' and ORDER_CON == 'ORDER_CON_04'">
			, CNCL_CON = #{CNCL_CON}			/*취소상태*/
		</if>	
		<!-- <if test="CNCL_CON != null or CNCL_CON != ''">
			, CNCL_REQDTM = SYSDATE				/*취소 요청일시*/
		</if> -->
		<if test="RFND_CON != null and RFND_CON != '' and ORDER_CON == 'ORDER_CON_07'">
			, RFND_CON = #{RFND_CON}	/*환불상태*/
		</if>	
		<!-- <if test="RFND_CON != null or RFND_CON != ''">
			, RFND_REQDTM = SYSDATE	/*환불 요청일시*/
		</if> -->
			 <!--, PAY_METD = #{PAY_METD}	/*결제수단*/ -->
		     <!-- , DLVY_COM = #{DLVY_COM}	/*배송업체*/
		     , DLVY_TDN = #{DLVY_TDN}	/*배송운송장번호*/ -->
		     , MODP_ID = #{MODP_ID}
		     , MOD_DTM = SYSDATE
		 WHERE ORDER_NUM = #{ORDER_NUM}
		 AND PD_CODE=#{PD_CODE}
		 <if test=" OPTION1_VALUE !=  '' and OPTION1_VALUE != null ">
         	AND OPTION1_VALUE = #{OPTION1_VALUE}
		 </if>
		 <if test=' OPTION2_VALUE != "" and OPTION2_VALUE != null '>
		    AND OPTION2_VALUE = #{OPTION2_VALUE}
		 </if>
		 <if test=' OPTION3_VALUE != "" and OPTION3_VALUE != null '>
		    AND OPTION3_VALUE = #{OPTION3_VALUE}
		 </if>
		   <!-- AND SUPR_ID = 'C00003'  / 2020-09-08 JW-->
	</update>
	
	<!-- 배송정보 수정 -->
	<update id="getDeliveryUpdate" parameterType="mall.web.domain.TB_ODDLAIXM">
		UPDATE
			POLARBEAR.TB_ODDLAIXM
		SET
			DLAR_GUBN = #{DLAR_GUBN}	/*배송지구분*/
			, RECV_PERS = #{RECV_PERS}	/*수령인*/
			, POST_NUM = #{POST_NUM}	/*우편번호*/
			, BASC_ADDR = #{BASC_ADDR} /*기본주소*/
			, DTL_ADDR = #{DTL_ADDR}	/*상세주소*/
			, RECV_TELN = #{RECV_TELN} /*수령인 전화번호*/
			, RECV_CPON = #{RECV_CPON} /*수령인 휴대전화*/
			, DLVY_MSG = #{DLVY_MSG}	/*배송메세지*/
			, MODP_ID = #{MODP_ID}
			, MOD_DTM = SYSDATE
			, DLAR_TIME = #{DLAR_TIME}
		<if test="DLAR_DATE != null and DLAR_DATE != ''">
			, DLAR_DATE = #{DLAR_DATE}
		</if>
		WHERE ORDER_NUM = #{ORDER_NUM}
	</update>
	
	<!-- 피킹리스트 -->
	<select id="pickingList" parameterType="mall.web.domain.TB_ODINFOXM" resultType="mall.web.domain.TB_ODINFOXM">
		SELECT *
              FROM (
                    SELECT A.ORDER_NUM    /*주문번호*/
                         , TO_CHAR(TO_DATE(ORDER_DATE,DECODE(LENGTH(ORDER_DATE),8,'YYYYMMDD','YYYYMMDDHH24MISS'))
		     								,DECODE(LENGTH(ORDER_DATE),8,'yyyy-MM-dd','yyyy-MM-dd HH24:mi:SS')) AS ORDER_DATE    /*주문일자*/
                         , A.MEMB_ID                                  /*회원ID (주문자)*/
                         , POLARBEAR.FC_GET_MEMBID_NM(A.MEMB_ID) AS MEMB_NM     /*회원ID명(주문자)*/
                         , B.PD_NAME
                         , A.ORDER_AMT    /*주문금액*/
                         , A.ORDER_CON                                        /*주문상태*/
                         , POLARBEAR.FC_GET_COMCOD_NM(A.ORDER_CON) AS ORDER_CON_NM    /*주문상태 명*/
                         , A.PAY_METD                                        /*결제수단*/
                         , POLARBEAR.FC_GET_COMCOD_NM(A.PAY_METD) AS PAY_METD_NM      /*결제수단 명*/
                         , (SELECT COUNT(*)-1 FROM POLARBEAR.TB_ODINFOXD WHERE ORDER_NUM = A.ORDER_NUM) AS count /*주문 제품 갯수*/
                         , B.ORDER_QTY /*제품수량*/
                         , C.PD_STD /*규격*/
                         , C.PD_BARCD  /*바코드*/
                         , C.KEEP_GUBN	/*보관온도기준*/
                         , C.PACKING_GUBN	/*패킹기준*/
                         , D.COM_NAME		/*회사명*/
                         <!-- , NVL(D.COM_NAME, D.MEMB_NAME) COM_ORD -->
                         , CASE WHEN D.COM_NAME IS NULL THEN D.MEMB_NAME
                           ELSE D.COM_NAME || '(' || D.MEMB_NAME || ')'
                           END COM_ORD
                         , D.CAR_NUM
                         , POLARBEAR.FC_GET_COMCOD_NM(D.CAR_NUM) AS CAR_NUM_NM      /*차량번호*/
                         , (SELECT CUT_UNIT FROM POLARBEAR.TB_PDCUTXM WHERE PD_CODE = B.PD_CODE AND SEQ = B.PD_CUT_SEQ ) PD_CUT_SEQ
		     			 , NVL ( (SELECT COMDCD_NAME FROM POLARBEAR.TB_COMCODXD WHERE COMM_CODE = 'OPTION_GUBN' AND COMD_CODE = B.OPTION_CODE )
		     			 , (SELECT OPTDCD_NAME FROM POLARBEAR.TB_OPTCODXD M, POLARBEAR.TB_PDINFOXM N  WHERE M.OPTD_CODE = B.OPTION_CODE AND N.PD_CODE = B.PD_CODE AND M.OPTM_CODE = N.OPTION_GUBN) ) AS OPTION_CODE
		     			 , C.DLVY_GUBN
                      FROM POLARBEAR.TB_ODINFOXM A      /*주문정보 마스터*/
                     INNER JOIN POLARBEAR.TB_ODINFOXD B /*주문정보 상세*/
                        ON A.ORDER_NUM = B.ORDER_NUM
                     INNER JOIN POLARBEAR.TB_PDINFOXM C
                        ON B.PD_CODE = C.PD_CODE    
                     INNER JOIN POLARBEAR.TB_MBINFOXM D
                        ON A.MEMB_ID = D.MEMB_ID           
                   <!-- WHERE TO_CHAR(TO_DATE(A.ORDER_DATE,'yyyy-MM-dd'),'yyyy-MM-dd') = TO_CHAR(SYSDATE,'yyyy-MM-dd') -->
                     WHERE  A.ORDER_CON IN ('ORDER_CON_02','ORDER_CON_03')
                       <if test="list != null and list.size!=0">
                       AND A.ORDER_NUM IN 
	                      <foreach item="item" index="index" collection="list" open="(" separator="," close=")">
	                      	#{item}
	                      </foreach> 
                       </if>
                       <if test="list != null and list.size==0">
                       AND A.ORDER_NUM IN ('')
                       </if>
                    )
			<if test="ORDER_GUBUN != null and ORDER_GUBUN != ''">
				<if test='ORDER_GUBUN == "goods"'>
           			ORDER BY DLVY_GUBN, KEEP_GUBN, PACKING_GUBN
				</if>
				<if test='ORDER_GUBUN == "com"'>
           			ORDER BY DLVY_GUBN, COM_ORD, KEEP_GUBN, PACKING_GUBN 
				</if>
				<if test='ORDER_GUBUN == "car"'>
           			ORDER BY DLVY_GUBN, CAR_NUM, COM_ORD, KEEP_GUBN, PACKING_GUBN 
				</if>
			</if>
			<if test="ORDER_GUBUN == null or ORDER_GUBUN == ''">
          		ORDER BY DLVY_GUBN, KEEP_GUBN, PACKING_GUBN 
			</if>
	</select>
	
	
	<!-- 배송정보 수정 -->
	<update id="updatePickingList" parameterType="java.util.List">
		UPDATE
			POLARBEAR.TB_ODINFOXM
		SET
			ORDER_CON = 'ORDER_CON_03'	/*주문상태*/
		  	,MOD_DTM = SYSDATE
		  	,MODP_ID = #{MODP_ID}
		WHERE ORDER_NUM = #{ORDER_NUM} <!-- #{list.ORDER_NUM} -->
	</update>
		
	<!-- 엑셀리스트-->
	<select id="excelList" parameterType="mall.web.domain.TB_ODINFOXM" resultType="HashMap"><!-- 원래 : mall.web.domain.XTB_ODINFOXM -->
			<include refid="default.pagerHeader"/>	
			SELECT *
			 FROM
			(
			  SELECT  ORDER_DATE    /*주문일자*/
			  			 , PAY_DTM		  /*결제일시*/
				         , ORDER_NUM    /*주문번호*/
				         , ORDER_CON
				         , MEM.MEMB_ID AS MEMB_ID
				      	 , TRIM(MEMB_NM) AS MEMB_NM     /*회원ID명(주문자)*/
					     , MEM.COM_NAME     /*(회사명)*/
					     , MEM.COM_BUNB
					     , PD_NAME || DECODE(count,0,'',' 외 '||count||'종') AS PD_NAME /*주문상품*/
					     , ORDER_AMT
					     , DLVY_AMT
					     , ORDER_AMT - DLVY_AMT AS REAL_AMT 
					     , ORDER_CON_NM || DECODE(INFO.PAY_METD_NM,'','',DECODE(INFO.PAY_METD_NM,'','',' (' || INFO.PAY_METD_NM || ')')) AS ORDER_CON_NM
					     , DLAR_GUBN || ' ' || DLAR_DATE_TIME AS DLAR_GUBN
					     , DLVY_MSG
					     , INFO.ADM_REF
					     , PAY_METD		/*20190531_결제수단추가*/
			    FROM (
					SELECT A.ORDER_NUM
					     , TO_CHAR(TO_DATE(ORDER_DATE,DECODE(LENGTH(ORDER_DATE),8,'YYYYMMDD','YYYYMMDDHH24MISS'))
		     								,DECODE(LENGTH(ORDER_DATE),8,'yyyy-MM-dd','yyyy-MM-dd HH24:mi:SS')) AS ORDER_DATE    /*주문일자*/
					     , A.MEMB_ID
					     , (SELECT MEMB_NAME FROM POLARBEAR.TB_MBINFOXM WHERE MEMB_ID = A.MEMB_ID) AS MEMB_NM
					     , C.RECV_PERS
					     , (SELECT PD_NAME FROM POLARBEAR.TB_ODINFOXD WHERE ORDER_NUM = A.ORDER_NUM AND ROWNUM = 1) AS PD_NAME
					     , A.ORDER_AMT 
					     , A.ORDER_CON
					     , POLARBEAR.FC_GET_COMCOD_NM(A.ORDER_CON) AS ORDER_CON_NM 
					     , A.PAY_METD	
					     , POLARBEAR.FC_GET_COMCOD_NM(A.PAY_METD) AS PAY_METD_NM 
					     , (SELECT COUNT(*)-1 FROM POLARBEAR.TB_ODINFOXD WHERE ORDER_NUM = A.ORDER_NUM) AS count
					     , ORDER_DTM
					     , PAY_DTM	
					     , DECODE(DAP_YN,'Y',DLVY_AMT,'0') AS DLVY_AMT 
					     , DECODE(DLAR_GUBN,'DLAR_GUBN_05','현장출고','직배송요청') AS DLAR_GUBN 
					     , DECODE(DLVY_MSG,'',' ','있음') AS DLVY_MSG
			             , DECODE((SELECT ADM_REF 
					                      FROM POLARBEAR.TB_MBINFOXM MBINFO, POLARBEAR.TB_ODINFOXM ODINFO 
					                    WHERE MBINFO.MEMB_ID = ODINFO.MEMB_ID 
					                        AND ODINFO.ORDER_NUM = A.ORDER_NUM),'',' ','있음') AS ADM_REF  
                        <!-- , NVL(TO_CHAR(TO_DATE(C.DLAR_DATE,'YYYYMMDD'),'YYYY-MM-DD'),'')|| ' '||C.DLAR_TIME AS DLAR_DATE_TIME -->
                        ,DECODE(LENGTH(DLAR_DATE),8,TO_CHAR(TO_DATE(DLAR_DATE,'YYYYMMDD'),'YYYY-MM-DD'),'')|| ' '||DLAR_TIME AS DLAR_DATE_TIME   /*출고 시간*/
					  FROM POLARBEAR.TB_ODINFOXM A  
					 INNER JOIN POLARBEAR.TB_ODDLAIXM C /*주문배송지정보*/
					    ON A.ORDER_NUM = C.ORDER_NUM
					 WHERE DEL_YN IS NULL OR DEL_YN = 'N'
				    ) INFO
			        LEFT OUTER JOIN POLARBEAR.TB_MBINFOXM MEM
			        ON INFO.MEMB_ID = MEM.MEMB_ID
	        	)
				<include refid="searchCondition"/>
				<if test="list != null and list.size!=0">
                       AND (1,ORDER_NUM) IN
	               <foreach item="item" index="index" collection="list" open="(" separator="," close=")">
	         	        	(1,#{item})
	               </foreach> 
             	</if>
			<if test="ORDER_GUBUN != null and ORDER_GUBUN != ''">
				<if test='ORDER_GUBUN == "DATE_ORDER"'>
					<if test='DATE_ORDER == "desc"'>
						ORDER BY ORDER_DATE desc
					</if>	
					<if test='DATE_ORDER == "asc"'>
						ORDER BY ORDER_DATE asc
					</if>	
				</if>
				<if test='ORDER_GUBUN == "MEMB_NM_ORDER"'>
					<if test='MEMB_NM_ORDER == "desc"'>
						ORDER BY MEMB_NM desc
					</if>	
					<if test='MEMB_NM_ORDER == "asc"'>
						ORDER BY MEMB_NM asc
					</if>
				</if>
				<if test='ORDER_GUBUN == "COM_NAME_ORDER"'>
					<if test='MEMB_NM_ORDER == "desc"'>
						ORDER BY COM_NAME desc nulls last
					</if>	
					<if test='MEMB_NM_ORDER == "asc"'>
						ORDER BY COM_NAME asc
					</if>
				</if>
			</if>
			<if test="ORDER_GUBUN == null or ORDER_GUBUN == ''">
				ORDER BY ORDER_DATE desc
			</if>
		<include refid="default.pagerFooter"/>
	</select>
	
	<!-- 엑셀리스트(디테일)-->
	<select id="detailExcelList" parameterType="mall.web.domain.TB_ODINFOXM" resultType="HashMap">
	SELECT ODA.*
	     , PD.PD_BARCD
	     , POLARBEAR.FC_GET_COMCOD_NM(PD.TAX_GUBN) AS TAX_GUBN
	     , ODA.PD_PRICE - ODA.PDDC_VAL AS ORDER_PREICE 
	  FROM 
	  (
	    SELECT ODM.*
	         , ODD.PD_CODE
	         , ODD.PD_NAME
	         , (SELECT CUT_UNIT FROM POLARBEAR.TB_PDCUTXM WHERE PD_CODE = ODD.PD_CODE AND SEQ = ODD.PD_CUT_SEQ ) PD_CUT_SEQ
	         , (SELECT COMDCD_NAME FROM POLARBEAR.TB_COMCODXD WHERE COMM_CODE = 'OPTION_GUBN' AND COMD_CODE = ODD.OPTION_CODE) OPTION_NAME
	         , ODD.ORDER_QTY
	         , ODD.PD_PRICE
	         , ODD.PDDC_VAL
	         , ODD.ORDER_AMT
	         , NVL( (SELECT SUPR_NAME FROM POLARBEAR.TB_SPINFOXM WHERE SUPR_ID = ODD.SUPR_ID) , '미등록업체') AS SUPR_NAME
	         , NVL( (SELECT COMDCD_NAME FROM POLARBEAR.TB_COMCODXD WHERE COMM_CODE = 'DLVY_COM' AND COMD_CODE = ODD.DLVY_COM), ODD.DLVY_COM) AS DLVY_COM
	         , ODD.DLVY_TDN
	         , ODD.LINK_ORDER_KEY
	      FROM
	      (
	        SELECT ORDER_NUM    
	             ,TO_CHAR(TO_DATE(ORDER_DATE,DECODE(LENGTH(ORDER_DATE),8,'YYYYMMDD','YYYYMMDDHH24MISS'))
		     								,DECODE(LENGTH(ORDER_DATE),8,'yyyy-MM-dd','yyyy-MM-dd HH24:mi:SS')) AS ORDER_DATE
	             , OD.MEMB_ID                               
	             , ME.COM_NAME
	             , POLARBEAR.FC_GET_MEMBID_NM(OD.MEMB_ID) AS MEMB_NM
	             , DAP_YN
	             , COM_BUNB
	          FROM POLARBEAR.TB_ODINFOXM OD,POLARBEAR.TB_MBINFOXM ME 
	         WHERE ORDER_NUM = #{ORDER_NUM} 
	           AND OD.MEMB_ID = ME.MEMB_ID
	      ) ODM
	      LEFT OUTER JOIN POLARBEAR.TB_ODINFOXD ODD
	      	ON ODM.ORDER_NUM = ODD.ORDER_NUM
	      	AND ODD.ORDER_QTY > 0
	  ) ODA
	  LEFT OUTER JOIN POLARBEAR.TB_PDINFOXM PD
	  	ON ODA.PD_CODE = PD.PD_CODE	      
	</select>
	
	<!-- 피킹리스트 (상품별)-->
	<select id="pickingGoodsList" parameterType="mall.web.domain.TB_ODINFOXM" resultType="mall.web.domain.TB_ODINFOXM">
		SELECT *
              FROM (
                    SELECT  B.PD_CODE
                    		,B.PD_NAME
                    		,C.INPUT_CNT
                    		,SUM (B.ORDER_QTY) AS ORDER_QTY                         /*주문수량*/		                 
		                 	,C.PD_STD                                               /*규격*/
		                 	,C.PD_BARCD                                            	/*바코드*/
		                	,C.KEEP_LOCATION										/*보관장소*/
		                	,C.KEEP_GUBN                                       		/*보관기준*/
		                	,C.PACKING_GUBN                                       	/*패킹기준*/
		                	,C.ATFL_ID												/*파일첨부*/
		                	,C.RPIMG_SEQ											/*대표이미지순번*/
		                	, (SELECT CUT_UNIT FROM POLARBEAR.TB_PDCUTXM WHERE PD_CODE = B.PD_CODE AND SEQ = B.PD_CUT_SEQ ) PD_CUT_SEQ
		     			    , NVL ( (SELECT COMDCD_NAME FROM POLARBEAR.TB_COMCODXD WHERE COMM_CODE = 'OPTION_GUBN' AND COMD_CODE = OPTION_CODE )
		     			    ,(SELECT OPTDCD_NAME FROM POLARBEAR.TB_OPTCODXD M, POLARBEAR.TB_PDINFOXM N  WHERE M.OPTM_CODE = N.OPTION_GUBN AND M.OPTD_CODE = B.OPTION_CODE AND N.PD_CODE = B.PD_CODE) ) AS OPTION_CODE
                        	,(SELECT COMDCD_NAME FROM POLARBEAR.TB_COMCODXD WHERE COMM_CODE = 'DLVY_GUBN' AND COMD_CODE = C.DLVY_GUBN) AS DLVY_GUBN
		              FROM POLARBEAR.TB_ODINFOXM A                                    		/*주문정보 마스터*/
		             	   INNER JOIN POLARBEAR.TB_ODINFOXD B ON A.ORDER_NUM = B.ORDER_NUM
		             	   INNER JOIN POLARBEAR.TB_PDINFOXM C ON B.PD_CODE = C.PD_CODE       
                   <!-- WHERE TO_CHAR(TO_DATE(A.ORDER_DATE,'yyyy-MM-dd'),'yyyy-MM-dd') = TO_CHAR(SYSDATE,'yyyy-MM-dd') -->
                     WHERE  A.ORDER_CON IN ('ORDER_CON_02','ORDER_CON_03')
                       <if test="list != null and list.size!=0">
                       AND A.ORDER_NUM IN 
	                      <foreach item="item" index="index" collection="list" open="(" separator="," close=")">
	                      	#{item}
	                      </foreach> 
                       </if>
                       <if test="list != null and list.size==0">
                       AND A.ORDER_NUM IN ('')
                       </if>
                     GROUP BY	B.PD_CODE , 
                     				B.PD_NAME, 
                     				B.OPTION_CODE, 
                     				B.PD_CUT_SEQ, 
                     				C.PD_STD, 
                     				C.PD_BARCD, 
                     				C.KEEP_LOCATION, 
                    				C.PACKING_GUBN, 
                    				C.KEEP_GUBN , 
                     				C.ATFL_ID, 
                     				C.RPIMG_SEQ,
                     				C.INPUT_CNT,
                     				C.DLVY_GUBN
                    HAVING SUM (B.ORDER_QTY)>0
                    )
			<if test="ORDER_GUBUN != null and ORDER_GUBUN != ''">
				<if test='ORDER_GUBUN == "goods"'>
					ORDER BY DLVY_GUBN, KEEP_GUBN, PACKING_GUBN 
				</if>
				<if test='ORDER_GUBUN == "com"'>
           			ORDER BY DLVY_GUBN, COM_ORD, KEEP_GUBN, PACKING_GUBN 
				</if>
				<if test='ORDER_GUBUN == "car"'>
           			ORDER BY DLVY_GUBN, CAR_NUM, COM_ORD, KEEP_GUBN, PACKING_GUBN 
				</if>
			</if>
			<if test="ORDER_GUBUN == null or ORDER_GUBUN == ''">
				ORDER BY DLVY_GUBN, KEEP_GUBN, PACKING_GUBN 
			</if>
	</select>
	
	<!-- 피킹리스트 (매출처별)-->
	<select id="pickingComList" parameterType="mall.web.domain.TB_ODINFOXM" resultType="mall.web.domain.TB_ODINFOXM">
		SELECT *
              FROM (
                    SELECT 
		                 A.MEMB_ID,                                      /*회원ID (주문자)*/
		                 POLARBEAR.FC_GET_MEMBID_NM (A.MEMB_ID) AS MEMB_NM,        /*회원ID명(주문자)*/
		                 B.PD_NAME,
		                 C.INPUT_CNT,	              
		                 SUM (B.ORDER_QTY) AS ORDER_QTY,                  /*주문수량*/
		                 C.PD_STD,                                               /*규격*/
		                 C.PD_BARCD,                                            /*바코드*/
		                 C.KEEP_GUBN,                                        /*보관온도기준*/
		                 C.PACKING_GUBN,                                       /*패킹기준*/
		                 D.COM_NAME,                                            /*회사명*/
		                 CASE
		                    WHEN D.COM_NAME IS NULL THEN D.MEMB_NAME
		                    ELSE D.COM_NAME || '(' || D.MEMB_NAME || ')'
		                 END
		                    COM_ORD,
		                 C.ATFL_ID,
		                 C.RPIMG_SEQ
		                 , (SELECT CUT_UNIT FROM POLARBEAR.TB_PDCUTXM WHERE PD_CODE = B.PD_CODE AND SEQ = B.PD_CUT_SEQ ) PD_CUT_SEQ
		     			 , NVL ( (SELECT COMDCD_NAME FROM POLARBEAR.TB_COMCODXD WHERE COMM_CODE = 'OPTION_GUBN' AND COMD_CODE = OPTION_CODE )
		     			 , (SELECT OPTDCD_NAME FROM POLARBEAR.TB_OPTCODXD M, POLARBEAR.TB_PDINFOXM N  WHERE M.OPTM_CODE = N.OPTION_GUBN AND M.OPTD_CODE = B.OPTION_CODE AND N.PD_CODE = B.PD_CODE) ) AS OPTION_CODE
                         , (SELECT COMDCD_NAME FROM POLARBEAR.TB_COMCODXD WHERE COMM_CODE = 'DLVY_GUBN' AND COMD_CODE = C.DLVY_GUBN) AS DLVY_GUBN
		            FROM POLARBEAR.TB_ODINFOXM A                                    /*주문정보 마스터*/
		                 INNER JOIN POLARBEAR.TB_ODINFOXD B                          /*주문정보 상세*/
		                                         ON A.ORDER_NUM = B.ORDER_NUM
		                 INNER JOIN POLARBEAR.TB_PDINFOXM C ON B.PD_CODE = C.PD_CODE
		                 INNER JOIN POLARBEAR.TB_MBINFOXM D ON A.MEMB_ID = D.MEMB_ID     
                   <!-- WHERE TO_CHAR(TO_DATE(A.ORDER_DATE,'yyyy-MM-dd'),'yyyy-MM-dd') = TO_CHAR(SYSDATE,'yyyy-MM-dd') -->
                     WHERE  A.ORDER_CON IN ('ORDER_CON_02','ORDER_CON_03')
                       <if test="list != null and list.size!=0">
                       AND A.ORDER_NUM IN 
	                      <foreach item="item" index="index" collection="list" open="(" separator="," close=")">
	                      	#{item}
	                      </foreach> 
                       </if>
                       <if test="list != null and list.size==0">
                       AND A.ORDER_NUM IN ('')
                       </if>
                    GROUP BY	B.PD_CODE , 
                    				B.PD_NAME, 
                    				B.OPTION_CODE, 
                    				B.PD_CUT_SEQ, 
                    				C.PD_STD, 
                    				C.PD_BARCD, 
                    				C.KEEP_LOCATION,
                    				C.INPUT_CNT, 
                    				D.COM_NAME,
                    				C.PACKING_GUBN, 
                    				C.KEEP_GUBN , 
                    				C.ATFL_ID, 
                    				C.RPIMG_SEQ, 
                    				A.MEMB_ID, 
                    				D.MEMB_NAME,
                    				C.DLVY_GUBN
                   HAVING SUM (B.ORDER_QTY)>0
                    )
			<if test="ORDER_GUBUN != null and ORDER_GUBUN != ''">
				<if test='ORDER_GUBUN == "goods"'>
					ORDER BY DLVY_GUBN, KEEP_GUBN, PACKING_GUBN 
				</if>
				<if test='ORDER_GUBUN == "com"'>
           			ORDER BY DLVY_GUBN, COM_ORD, KEEP_GUBN, PACKING_GUBN
				</if>
				<if test='ORDER_GUBUN == "car"'>
           			ORDER BY DLVY_GUBN, CAR_NUM, COM_ORD, KEEP_GUBN, PACKING_GUBN
				</if>
			</if>
			<if test="ORDER_GUBUN == null or ORDER_GUBUN == ''">
				ORDER BY DLVY_GUBN, KEEP_GUBN, PACKING_GUBN 
			</if>
	</select>
	
	<!-- 피킹리스트 (차량별)-->
	<select id="pickingCarList" parameterType="mall.web.domain.TB_ODINFOXM" resultType="mall.web.domain.TB_ODINFOXM">
		SELECT *
              FROM (
                    SELECT
		                 A.MEMB_ID,                                      /*회원ID (주문자)*/
		                 POLARBEAR.FC_GET_MEMBID_NM (A.MEMB_ID) AS MEMB_NM,        /*회원ID명(주문자)*/
		                 B.PD_NAME,
		                 C.INPUT_CNT,
		                 SUM (B.ORDER_QTY) AS ORDER_QTY,                  /*주문수량*/
		                 C.PD_STD,                                        /*규격*/
		                 C.PD_BARCD,                                      /*바코드*/
		                 C.KEEP_GUBN,                                     /*보관온도기준*/
		                 C.PACKING_GUBN,                                  /*패킹기준*/
		                 D.COM_NAME,                                      /*회사명*/
		                 CASE
		                    WHEN D.COM_NAME IS NULL THEN D.MEMB_NAME
		                    ELSE D.COM_NAME || '(' || D.MEMB_NAME || ')'
		                 END
		                    COM_ORD,
		                 D.CAR_NUM,
		                 POLARBEAR.FC_GET_COMCOD_NM (D.CAR_NUM) AS CAR_NUM_NM,           /*차량번호*/
		                 C.ATFL_ID,											/*대표이미지*/
		                 C.RPIMG_SEQ    									/*대표이미지 순번*/
		                 , (SELECT CUT_UNIT FROM POLARBEAR.TB_PDCUTXM WHERE PD_CODE = B.PD_CODE AND SEQ = B.PD_CUT_SEQ ) PD_CUT_SEQ
		     			 , NVL ( (SELECT COMDCD_NAME FROM POLARBEAR.TB_COMCODXD WHERE COMM_CODE = 'OPTION_GUBN' AND COMD_CODE = OPTION_CODE ),
                        		(SELECT OPTDCD_NAME FROM POLARBEAR.TB_OPTCODXD M, POLARBEAR.TB_PDINFOXM N  WHERE M.OPTM_CODE = N.OPTION_GUBN AND M.OPTD_CODE = B.OPTION_CODE AND N.PD_CODE = B.PD_CODE) ) AS OPTION_CODE
                         ,(SELECT COMDCD_NAME FROM POLARBEAR.TB_COMCODXD WHERE COMM_CODE = 'DLVY_GUBN' AND COMD_CODE = C.DLVY_GUBN) AS DLVY_GUBN
		             FROM POLARBEAR.TB_ODINFOXM A                                    /*주문정보 마스터*/
		                 INNER JOIN POLARBEAR.TB_ODINFOXD B                          /*주문정보 상세*/
		                                         ON A.ORDER_NUM = B.ORDER_NUM
		                 INNER JOIN POLARBEAR.TB_PDINFOXM C ON B.PD_CODE = C.PD_CODE
		                 INNER JOIN POLARBEAR.TB_MBINFOXM D ON A.MEMB_ID = D.MEMB_ID
                   <!-- WHERE TO_CHAR(TO_DATE(A.ORDER_DATE,'yyyy-MM-dd'),'yyyy-MM-dd') = TO_CHAR(SYSDATE,'yyyy-MM-dd') -->
                     WHERE  A.ORDER_CON IN ('ORDER_CON_02','ORDER_CON_03')
                       <if test="list != null and list.size!=0">
                       AND A.ORDER_NUM IN 
	                      <foreach item="item" index="index" collection="list" open="(" separator="," close=")">
	                      	#{item}
	                      </foreach> 
                       </if>
                       <if test="list != null and list.size==0">
                       AND A.ORDER_NUM IN ('')
                       </if>
                    GROUP BY	B.PD_CODE, 
                    				B.PD_NAME, 
                    				B.OPTION_CODE, 
                    				B.PD_CUT_SEQ, 
                    				C.PD_STD, 
                    				C.PD_BARCD, 
                    				C.KEEP_LOCATION, 
                    				C.PACKING_GUBN, 
                    				C.KEEP_GUBN, 
                    				C.ATFL_ID, 
                    				C.RPIMG_SEQ,
                    				C.INPUT_CNT, 
                    				A.MEMB_ID, 
                    				D.MEMB_NAME,
                    				D.COM_NAME,
                    				D.CAR_NUM,
                    				C.DLVY_GUBN
                   HAVING SUM (B.ORDER_QTY)>0
                    )
			<if test="ORDER_GUBUN != null and ORDER_GUBUN != ''">
				<if test='ORDER_GUBUN == "goods"'>
					ORDER BY DLVY_GUBN, KEEP_GUBN, PACKING_GUBN  
				</if>
				<if test='ORDER_GUBUN == "com"'>
           			ORDER BY DLVY_GUBN, COM_ORD, KEEP_GUBN, PACKING_GUBN 
				</if>
				<if test='ORDER_GUBUN == "car"'>
           			ORDER BY DLVY_GUBN, CAR_NUM, COM_ORD, KEEP_GUBN, PACKING_GUBN 
				</if>
			</if>
			<if test="ORDER_GUBUN == null or ORDER_GUBUN == ''">
				ORDER BY DLVY_GUBN, KEEP_GUBN, PACKING_GUBN  
			</if>
	</select>
	
	
	<!-- 주문내역 삭제 -->
	<update id="deleteOrdList" parameterType="java.util.List">
		UPDATE POLARBEAR.TB_ODINFOXM
		   SET DEL_YN = 'Y',		/*삭제여부*/
		   	   MOD_DTM = SYSDATE	/*수정날짜*/
		 WHERE ORDER_NUM = #{ORDER_NUM}
		   AND ORDER_CON IN ('ORDER_CON_01','ORDER_CON_04','ORDER_CON_07')
	</update>
	
	<!-- 주문내역 상세삭제 -->
	<update id="deleteOrdDetail" parameterType="java.util.List">
		UPDATE POLARBEAR.TB_ODINFOXD
		SET DEL_YN = 'Y',		/*삭제여부*/
			MOD_DTM = SYSDATE,	/*수정날짜*/
		    MODP_ID = #{MODP_ID}
		WHERE ORDER_NUM = #{ORDER_NUM} <!-- #{list.ORDER_NUM} -->
			AND ORDER_CON IN ('ORDER_CON_01','ORDER_CON_04','ORDER_CON_07')
	</update>
	
	<!-- 주문정보 수량변경 -->
	<update id="updateDatailQty" parameterType="mall.web.domain.TB_ODINFOXD">
		UPDATE
			POLARBEAR.TB_ODINFOXD
		SET
			ORDER_QTY = #{ORDER_QTY},		/*주문수량*/
			ORDER_AMT = CASE
				WHEN PDDC_GUBN = 'PDDC_GUBN_02' THEN (PD_PRICE - PDDC_VAL) * #{ORDER_QTY}
                WHEN PDDC_GUBN = 'PDDC_GUBN_03' THEN (PD_PRICE - (PD_PRICE * (PDDC_VAL/100))) *#{ORDER_QTY}
				ELSE PD_PRICE *#{ORDER_QTY} 
			END,
			MOD_DTM = SYSDATE,
			MODP_ID = #{MODP_ID}		   
			<if test='MEMB_GUBN == "MEMB_GUBN_03" '>
			, DLVY_TDN = #{DTL_DLVY_TDN}
			, DLVY_COM = #{DLVY_COM}
			, ORDER_CON = #{ORDER_CON}
			, DLVY_TDN_MODP_DATE = CASE WHEN DLVY_TDN = NULL AND #{DTL_DLVY_TDN} = NULL 
											THEN DLVY_TDN_MODP_DATE 
			                            WHEN DLVY_TDN != #{DTL_DLVY_TDN}
			                            	THEN SYSDATE
		                            	WHEN DLVY_TDN = #{DTL_DLVY_TDN}
		                           			THEN DLVY_TDN_MODP_DATE
			                            ELSE SYSDATE END
			</if>
			   
	    WHERE ORDER_NUM = #{ORDER_NUM} <!-- #{list.ORDER_NUM} -->
	      AND ORDER_DTNUM = #{ORDER_DTNUM}
	      AND LINK_ORDER_KEY IS NULL 	<!-- 오너클랜 주문 진행중이지 않을 경우만 수정 가능 -->
	       
   		  <!-- AND ORDER_CON = 'ORDER_CON_01' -->
	</update>
	
	<!-- 주문정보 수량/가격변경 -->
	<update id="updateMasterQty" parameterType="mall.web.domain.TB_ODINFOXM">
		UPDATE 
			POLARBEAR.TB_ODINFOXM
		SET
			ORDER_AMT = (SELECT SUM(ORDER_AMT) FROM POLARBEAR.TB_ODINFOXD WHERE ORDER_NUM = #{ORDER_NUM}) + DLVY_AMT,
		    PAY_AMT = CASE
		    					WHEN PAY_AMT IS NULL THEN NULL
		    					ELSE (SELECT SUM(ORDER_AMT) FROM POLARBEAR.TB_ODINFOXD WHERE ORDER_NUM = #{ORDER_NUM}) + DLVY_AMT 
		    				END,
			MOD_DTM = SYSDATE
		WHERE ORDER_NUM = #{ORDER_NUM}
		   <!-- AND ORDER_CON = 'ORDER_CON_01' -->
	</update>
	
	
	<!-- 상품 공급업체 리스트 불러오기 2020-02-25 -->
	<select id="getPdSuprList" parameterType="mall.web.domain.TB_ODINFOXM" resultType="HashMap">		
		  SELECT SUM(DLVY_AMT_REAL) AS DLVY_AMT_REAL
		  		, SUM(DLVY_AMT) AS DLVY_AMT
	            , F.SUPR_ID
	            , F.SUPR_NAME
	      FROM(
	            SELECT SUM(SUPR_AMT) AS DLVY_AMT_REAL
	            	   , SUM(ORIGIN_SUPR_AMT) AS DLVY_AMT
	                   , G.SUPR_ID
	                   , G.SUPR_NAME
	            FROM ( SELECT  B.SUPR_ID                                                           
	                        , A.DLVR_INDI_YN                                                             
	                        , A.DLVY_SORT
	                        , C.ORDER_NUM 
	                        , D.SUPR_NAME 
	                        , CASE A.DLVY_SORT WHEN 'PRICE_DESC' THEN MAX(C.IMSI_DLVY_AMT) ELSE MIN(C.IMSI_DLVY_AMT) END AS SUPR_AMT   
	                        , CASE A.DLVY_SORT WHEN 'PRICE_DESC' THEN MAX(C.DLVY_AMT) ELSE MIN(C.DLVY_AMT) END AS ORIGIN_SUPR_AMT
	                    FROM POLARBEAR.TB_PDINFOXM A, POLARBEAR.TB_MBINFOXM B, POLARBEAR.TB_ODINFOXD C, POLARBEAR.TB_SPINFOXM D
	                    WHERE A.SUPR_ID = B.SUPR_ID
	                     AND B.SUPR_ID = D.SUPR_ID 
	                     AND A.PD_CODE = C.PD_CODE
	                     AND A.PD_CODE = C.SETPD_CODE
	                     <if test='MEMB_GUBN != "MEMB_GUBN_03" '>
	                        AND A.SUPR_ID =#{LOGIN_SUPR_ID}
	                     </if>
	                      AND C.ORDER_NUM = #{ORDER_NUM}
	                  GROUP BY B.SUPR_ID, A.DLVR_INDI_YN, A.DLVY_SORT, C.ORDER_NUM, D.SUPR_NAME) G
	                  GROUP BY G.ORDER_NUM, G.SUPR_ID,G.DLVR_INDI_YN, G.DLVY_SORT, G.SUPR_NAME
	                  ) F
	      GROUP BY F.SUPR_ID, F.SUPR_NAME
            
				
				
		<!-- SELECT A.SUPR_ID
		     , NVL( (SELECT SUPR_NAME FROM TB_SPINFOXM WHERE SUPR_ID = A.SUPR_ID) , '미등록업체') AS SUPR_NAME
		  FROM TB_ODINFOXD A
		 WHERE ORDER_NUM = #{ORDER_NUM}
		<if test='MEMB_GUBN != "MEMB_GUBN_03" '>
		   		AND SUPR_ID=#{LOGIN_SUPR_ID}
		 </if> 
		 GROUP BY SUPR_ID
		 ORDER BY SUPR_ID ASC	 -->	
	</select>
	

	<!-- 피킹리스트 엑셀(상품별)-->
	<select id="pickingGoodsExcel" parameterType="mall.web.domain.TB_ODINFOXM" resultType="HashMap">
		SELECT PD_CODE
		        , PD_NAME || NVL2(PD_CUT_SEQ,'(세절방식 : '||PD_CUT_SEQ||')','')||NVL2(OPTION_CODE,'(색상 : '||OPTION_CODE||')','') AS PD_NAME
		        , INPUT_CNT
		        , ORDER_QTY
		        , PD_STD
		        , PD_BARCD
		        , KEEP_LOCATION
                , KEEP_GUBN
                , PACKING_GUBN
		        , ATFL_ID
		        , RPIMG_SEQ
		        , DLVY_GUBN
              FROM (
                    SELECT  B.PD_CODE
                    		,B.PD_NAME
                    		,C.INPUT_CNT
                    		,SUM (B.ORDER_QTY) AS ORDER_QTY                         /*주문수량*/		                 
		                 	,C.PD_STD                                               /*규격*/
		                 	,C.PD_BARCD                                            	/*바코드*/
		                	,C.KEEP_LOCATION										/*보관장소*/
			                ,C.KEEP_GUBN
			                ,C.PACKING_GUBN		                	
		                	,C.ATFL_ID												/*파일첨부*/
		                	,C.RPIMG_SEQ											/*대표이미지순번*/
		                	, (SELECT CUT_UNIT FROM POLARBEAR.TB_PDCUTXM WHERE PD_CODE = B.PD_CODE AND SEQ = B.PD_CUT_SEQ ) PD_CUT_SEQ
			     			, NVL ( (SELECT COMDCD_NAME FROM POLARBEAR.TB_COMCODXD WHERE COMM_CODE = 'OPTION_GUBN' AND COMD_CODE = OPTION_CODE )
			     			, (SELECT OPTDCD_NAME FROM POLARBEAR.TB_OPTCODXD M, POLARBEAR.TB_PDINFOXM N  WHERE M.OPTM_CODE = N.OPTION_GUBN AND M.OPTD_CODE = B.OPTION_CODE AND N.PD_CODE = B.PD_CODE) ) AS OPTION_CODE
	                        , (SELECT COMDCD_NAME FROM POLARBEAR.TB_COMCODXD WHERE COMM_CODE = 'DLVY_GUBN' AND COMD_CODE = C.DLVY_GUBN) AS DLVY_GUBN
		              FROM POLARBEAR.TB_ODINFOXM A                                    		/*주문정보 마스터*/
		             	   INNER JOIN POLARBEAR.TB_ODINFOXD B ON A.ORDER_NUM = B.ORDER_NUM
		             	   INNER JOIN POLARBEAR.TB_PDINFOXM C ON B.PD_CODE = C.PD_CODE       
                   <!-- WHERE TO_CHAR(TO_DATE(A.ORDER_DATE,'yyyy-MM-dd'),'yyyy-MM-dd') = TO_CHAR(SYSDATE,'yyyy-MM-dd') -->
                     WHERE  A.ORDER_CON IN ('ORDER_CON_02','ORDER_CON_03')
                       <if test="list != null and list.size!=0">
                       AND A.ORDER_NUM IN 
	                      <foreach item="item" index="index" collection="list" open="(" separator="," close=")">
	                      	#{item}
	                      </foreach> 
                       </if>
                       <if test="list != null and list.size==0">
                       AND A.ORDER_NUM IN ('')
                       </if>
                     GROUP BY	B.PD_CODE, 
                     				B.PD_NAME, 
                     				B.OPTION_CODE, 
                     				B.PD_CUT_SEQ, 
                     				C.PD_STD, 
                     				C.PD_BARCD, 
                     				C.KEEP_LOCATION, 
                    				C.PACKING_GUBN, 
                    				C.KEEP_GUBN , 
                     				C.ATFL_ID, 
                     				C.RPIMG_SEQ,
                     				C.INPUT_CNT,
                     				C.DLVY_GUBN
                    HAVING SUM (B.ORDER_QTY)>0
                    )
			<if test="ORDER_GUBUN != null and ORDER_GUBUN != ''">
				<if test='ORDER_GUBUN == "goods"'>
					ORDER BY DLVY_GUBN, KEEP_GUBN, PACKING_GUBN  
				</if>
				<if test='ORDER_GUBUN == "com"'>
           			ORDER BY DLVY_GUBN, COM_ORD, KEEP_GUBN, PACKING_GUBN 
				</if>
				<if test='ORDER_GUBUN == "car"'>
           			ORDER BY DLVY_GUBN, CAR_NUM, COM_ORD, KEEP_GUBN, PACKING_GUBN 
				</if>
			</if>
			<if test="ORDER_GUBUN == null or ORDER_GUBUN == ''">
				ORDER BY DLVY_GUBN, KEEP_GUBN, PACKING_GUBN  
			</if>
	</select>
	
	<!-- 피킹리스트 엑셀(매출처별)-->
	<select id="pickingComExcel" parameterType="mall.web.domain.TB_ODINFOXM" resultType="HashMap">
		SELECT MEMB_ID
                , MEMB_NM
                , PD_NAME || NVL2(PD_CUT_SEQ,'(세절방식 : '||PD_CUT_SEQ||')','')||NVL2(OPTION_CODE,'(색상 : '||OPTION_CODE||')','') AS PD_NAME
                , PD_CODE
                , INPUT_CNT
                , ORDER_QTY
                , PD_STD
                , PD_BARCD
                , KEEP_GUBN
                , PACKING_GUBN
                , COM_NAME
                , COM_ORD
                , ATFL_ID
                , RPIMG_SEQ
                , DLVY_GUBN
              FROM (
                    SELECT 
		                 A.MEMB_ID,                                      /*회원ID (주문자)*/
		                 POLARBEAR.FC_GET_MEMBID_NM (A.MEMB_ID) AS MEMB_NM,        /*회원ID명(주문자)*/
		                 B.PD_NAME,
		                 B.PD_CODE,           
		                 C.INPUT_CNT,
		                 SUM (B.ORDER_QTY) AS ORDER_QTY,                  /*주문수량*/
		                 C.PD_STD,                                               /*규격*/
		                 C.PD_BARCD,                                            /*바코드*/
		                 C.KEEP_GUBN,                                        /*보관온도기준*/
		                 C.PACKING_GUBN,                                       /*패킹기준*/
		                 D.COM_NAME,                                            /*회사명*/
		                 CASE
		                    WHEN D.COM_NAME IS NULL THEN D.MEMB_NAME
		                    ELSE D.COM_NAME || '(' || D.MEMB_NAME || ')'
		                 END
		                    COM_ORD,
		                 C.ATFL_ID,
		                 C.RPIMG_SEQ
		                 , (SELECT CUT_UNIT FROM POLARBEAR.TB_PDCUTXM WHERE PD_CODE = B.PD_CODE AND SEQ = B.PD_CUT_SEQ ) PD_CUT_SEQ
		     			    , NVL ( (SELECT COMDCD_NAME FROM POLARBEAR.TB_COMCODXD WHERE COMM_CODE = 'OPTION_GUBN' AND COMD_CODE = OPTION_CODE )
                        ,(SELECT OPTDCD_NAME FROM POLARBEAR.TB_OPTCODXD M, POLARBEAR.TB_PDINFOXM N  WHERE M.OPTM_CODE = N.OPTION_GUBN AND M.OPTD_CODE = B.OPTION_CODE AND N.PD_CODE = B.PD_CODE) ) AS OPTION_CODE
                        ,(SELECT COMDCD_NAME FROM POLARBEAR.TB_COMCODXD WHERE COMM_CODE = 'DLVY_GUBN' AND COMD_CODE = C.DLVY_GUBN) AS DLVY_GUBN
		            FROM POLARBEAR.TB_ODINFOXM A                                    /*주문정보 마스터*/
		                 INNER JOIN POLARBEAR.TB_ODINFOXD B                          /*주문정보 상세*/
		                                         ON A.ORDER_NUM = B.ORDER_NUM
		                 INNER JOIN POLARBEAR.TB_PDINFOXM C ON B.PD_CODE = C.PD_CODE
		                 INNER JOIN POLARBEAR.TB_MBINFOXM D ON A.MEMB_ID = D.MEMB_ID     
                   <!-- WHERE TO_CHAR(TO_DATE(A.ORDER_DATE,'yyyy-MM-dd'),'yyyy-MM-dd') = TO_CHAR(SYSDATE,'yyyy-MM-dd') -->
                     WHERE  A.ORDER_CON IN ('ORDER_CON_02','ORDER_CON_03')
                       <if test="list != null and list.size!=0">
                       AND A.ORDER_NUM IN 
	                      <foreach item="item" index="index" collection="list" open="(" separator="," close=")">
	                      	#{item}
	                      </foreach> 
                       </if>
                       <if test="list != null and list.size==0">
                       AND A.ORDER_NUM IN ('')
                       </if>
                    GROUP BY	B.PD_CODE, 
                    				B.PD_NAME, 
                    				B.OPTION_CODE, 
                    				B.PD_CUT_SEQ,
                    				C.PD_STD, 
                    				C.PD_BARCD, 
                    				C.KEEP_LOCATION,
                    				C.INPUT_CNT, 
                    				D.COM_NAME,
                    				C.PACKING_GUBN, 
                    				C.KEEP_GUBN, 
                    				C.ATFL_ID, 
                    				C.RPIMG_SEQ, 
                    				A.MEMB_ID, 
                    				D.MEMB_NAME,
                    				C.DLVY_GUBN
                   HAVING SUM (B.ORDER_QTY)>0
                    )
			<if test="ORDER_GUBUN != null and ORDER_GUBUN != ''">
				<if test='ORDER_GUBUN == "goods"'>
					ORDER BY DLVY_GUBN, KEEP_GUBN, PACKING_GUBN   
				</if>
				<if test='ORDER_GUBUN == "com"'>
           			ORDER BY DLVY_GUBN, COM_ORD, KEEP_GUBN, PACKING_GUBN 
				</if>
				<if test='ORDER_GUBUN == "car"'>
           			ORDER BY DLVY_GUBN, CAR_NUM, COM_ORD, KEEP_GUBN, PACKING_GUBN 
				</if>
			</if>
			<if test="ORDER_GUBUN == null or ORDER_GUBUN == ''">
				ORDER BY DLVY_GUBN, KEEP_GUBN, PACKING_GUBN   
			</if>
	</select>
	
	<!-- 피킹리스트 엑셀(차량별)-->
	<select id="pickingCarExcel" parameterType="mall.web.domain.TB_ODINFOXM" resultType="HashMap">
		SELECT MEMB_ID
		        , MEMB_NM
		        , PD_NAME || NVL2(PD_CUT_SEQ,'(세절방식 : '||PD_CUT_SEQ||')','')||NVL2(OPTION_CODE,'(색상 : '||OPTION_CODE||')','') AS PD_NAME
		        , PD_CODE
		        , INPUT_CNT
		        , ORDER_QTY
		        , PD_STD
		        , PD_BARCD
		        , KEEP_GUBN
		        , PACKING_GUBN
		        , COM_NAME
		        , COM_ORD
		        , CAR_NUM
		        , CAR_NUM_NM
		        , ATFL_ID
		        , RPIMG_SEQ
		        , DLVY_GUBN
              FROM (
                    SELECT
		                 A.MEMB_ID,                                      /*회원ID (주문자)*/
		                 POLARBEAR.FC_GET_MEMBID_NM (A.MEMB_ID) AS MEMB_NM,        /*회원ID명(주문자)*/
		                 B.PD_NAME,
		                 B.PD_CODE,
		                 C.INPUT_CNT,
		                 SUM (B.ORDER_QTY) AS ORDER_QTY,                  /*주문수량*/
		                 C.PD_STD,                                        /*규격*/
		                 C.PD_BARCD,                                      /*바코드*/
		                 C.KEEP_GUBN,                                     /*보관온도기준*/
		                 C.PACKING_GUBN,                                  /*패킹기준*/
		                 D.COM_NAME,                                      /*회사명*/
		                 CASE
		                    WHEN D.COM_NAME IS NULL THEN D.MEMB_NAME
		                    ELSE D.COM_NAME || '(' || D.MEMB_NAME || ')'
		                 END
		                    COM_ORD,
		                 D.CAR_NUM,
		                 NVL(POLARBEAR.FC_GET_COMCOD_NM (D.CAR_NUM),'미등록') AS CAR_NUM_NM,           /*차량번호*/
		                 C.ATFL_ID,											/*대표이미지*/
		                 C.RPIMG_SEQ    									/*대표이미지 순번*/
		                 , (SELECT CUT_UNIT FROM POLARBEAR.TB_PDCUTXM WHERE PD_CODE = B.PD_CODE AND SEQ = B.PD_CUT_SEQ ) PD_CUT_SEQ
		     			 , NVL ( (SELECT COMDCD_NAME FROM POLARBEAR.TB_COMCODXD WHERE COMM_CODE = 'OPTION_GUBN' AND COMD_CODE = OPTION_CODE ),
                        	(SELECT OPTDCD_NAME FROM POLARBEAR.TB_OPTCODXD M, POLARBEAR.TB_PDINFOXM N  WHERE M.OPTM_CODE = N.OPTION_GUBN AND M.OPTD_CODE = B.OPTION_CODE AND N.PD_CODE = B.PD_CODE) ) AS OPTION_CODE
                        ,(SELECT COMDCD_NAME FROM POLARBEAR.TB_COMCODXD WHERE COMM_CODE = 'DLVY_GUBN' AND COMD_CODE = C.DLVY_GUBN) AS DLVY_GUBN
		             FROM POLARBEAR.TB_ODINFOXM A                                    /*주문정보 마스터*/
		                 INNER JOIN POLARBEAR.TB_ODINFOXD B                          /*주문정보 상세*/
		                                         ON A.ORDER_NUM = B.ORDER_NUM
		                 INNER JOIN POLARBEAR.TB_PDINFOXM C ON B.PD_CODE = C.PD_CODE
		                 INNER JOIN POLARBEAR.TB_MBINFOXM D ON A.MEMB_ID = D.MEMB_ID
                   <!-- WHERE TO_CHAR(TO_DATE(A.ORDER_DATE,'yyyy-MM-dd'),'yyyy-MM-dd') = TO_CHAR(SYSDATE,'yyyy-MM-dd') -->
                     WHERE  A.ORDER_CON IN ('ORDER_CON_02','ORDER_CON_03')
                       <if test="list != null and list.size!=0">
                       AND A.ORDER_NUM IN 
	                      <foreach item="item" index="index" collection="list" open="(" separator="," close=")">
	                      	#{item}
	                      </foreach> 
                       </if>
                       <if test="list != null and list.size==0">
                       AND A.ORDER_NUM IN ('')
                       </if>
                    GROUP BY	B.PD_CODE, 
                    				B.PD_NAME, 
                    				B.OPTION_CODE, 
                    				B.PD_CUT_SEQ, 
                    				C.PD_STD, 
                    				C.PD_BARCD, 
                    				C.KEEP_LOCATION, 
                    				C.PACKING_GUBN, 
                    				C.KEEP_GUBN , 
                    				C.ATFL_ID, 
                    				C.RPIMG_SEQ,
                    				C.INPUT_CNT, 
                    				A.MEMB_ID, 
                    				D.MEMB_NAME,
                    				D.COM_NAME,
                    				D.CAR_NUM,
                    				C.DLVY_GUBN
                   HAVING SUM (B.ORDER_QTY)>0
                    )
			<if test="ORDER_GUBUN != null and ORDER_GUBUN != ''">
				<if test='ORDER_GUBUN == "goods"'>
					ORDER BY DLVY_GUBN, KEEP_GUBN, PACKING_GUBN   
				</if>
				<if test='ORDER_GUBUN == "com"'>
           			ORDER BY DLVY_GUBN, COM_ORD, KEEP_GUBN, PACKING_GUBN 
				</if>
				<if test='ORDER_GUBUN == "car"'>
           			ORDER BY DLVY_GUBN, CAR_NUM, COM_ORD, KEEP_GUBN, PACKING_GUBN 
				</if>
			</if>
			<if test="ORDER_GUBUN == null or ORDER_GUBUN == ''">
				ORDER BY DLVY_GUBN, KEEP_GUBN, PACKING_GUBN   
			</if>
	</select>
	
	
	<!-- 리스트 목록 -->
	<select id="paginatedDeleteList" parameterType="mall.web.domain.TB_ODINFOXM" resultType="mall.web.domain.TB_ODINFOXM">
		<include refid="default.pagerHeader"/>	
			SELECT *
			 FROM
			(
			  SELECT  INFO.*
      			   	     , MEM.COM_NAME
			    FROM (
					SELECT A.ORDER_NUM    /*주문번호*/
					     , TO_CHAR(TO_DATE(ORDER_DATE,DECODE(LENGTH(ORDER_DATE),8,'YYYYMMDD','YYYYMMDDHH24MISS'))
		     								,DECODE(LENGTH(ORDER_DATE),8,'yyyy-MM-dd','yyyy-MM-dd HH24:mi:SS')) AS ORDER_DATE    /*주문일자*/
					     , A.MEMB_ID								  /*회원ID (주문자)*/
					     , (SELECT MEMB_NAME FROM POLARBEAR.TB_MBINFOXM WHERE MEMB_ID = A.MEMB_ID) AS MEMB_NM     /*회원ID명(주문자)*/
					     , C.RECV_PERS    /*수령인*/
					     <!-- , B.PD_NAME      /*제품명*/ -->
					     , (SELECT PD_NAME FROM POLARBEAR.TB_ODINFOXD WHERE ORDER_NUM = A.ORDER_NUM AND ROWNUM = 1) AS PD_NAME
					     , A.ORDER_AMT    /*주문금액*/
					     , A.ORDER_CON								        /*주문상태*/
					     , POLARBEAR.FC_GET_COMCOD_NM(A.ORDER_CON) AS ORDER_CON_NM    /*주문상태 명*/
					     , A.PAY_METD										/*결제수단*/
					     , POLARBEAR.FC_GET_COMCOD_NM(A.PAY_METD) AS PAY_METD_NM      /*결제수단 명*/
					     , (SELECT COUNT(*)-1 FROM POLARBEAR.TB_ODINFOXD WHERE ORDER_NUM = A.ORDER_NUM) AS count /*주문 제품 갯수*/
					     , ORDER_DTM		/*주문일시*/
					     , PAY_DTM			/*결제일시*/
					     , DECODE(DAP_YN,'Y',DLVY_AMT,'0') AS DLVY_AMT         /*배송료*/
					     , DECODE(DLAR_GUBN,'DLAR_GUBN_05','현장출고','직배송요청') AS DLAR_GUBN   /*출고방식*/
					     , DECODE(DLVY_MSG,'',' ','있음') AS DLVY_MSG    /*배송메세지 유무*/
			             , DECODE((SELECT ADM_REF 
					                      FROM POLARBEAR.TB_MBINFOXM MBINFO, POLARBEAR.TB_ODINFOXM ODINFO 
					                    WHERE MBINFO.MEMB_ID = ODINFO.MEMB_ID 
					                        AND ODINFO.ORDER_NUM = A.ORDER_NUM),'',' ','있음') AS ADM_REF    /*관리자설명참조 유무*/
                        , NVL(TO_CHAR(TO_DATE(C.DLAR_DATE,'YYYYMMDD'),'YYYY-MM-DD'),'')|| ' '||C.DLAR_TIME AS DLAR_DATE_TIME   /*출고 시간*/
					  FROM POLARBEAR.TB_ODINFOXM A      /*주문정보 마스터*/
					 <!-- INNER JOIN TB_ODINFOXD B /*주문정보 상세*/
					    ON A.ORDER_NUM = B.ORDER_NUM -->
					 INNER JOIN POLARBEAR.TB_ODDLAIXM C /*주문배송지정보*/
					    ON A.ORDER_NUM = C.ORDER_NUM
					 WHERE DEL_YN = 'Y'
				    ) INFO
			        LEFT OUTER JOIN POLARBEAR.TB_MBINFOXM MEM
			        ON INFO.MEMB_ID = MEM.MEMB_ID
	        	)
			<include refid="searchCondition"/>
			<if test="ORDER_GUBUN != null and ORDER_GUBUN != ''">
				<if test='ORDER_GUBUN == "DATE_ORDER"'>
					<if test='DATE_ORDER == "desc"'>
						ORDER BY ORDER_DATE desc
					</if>	
					<if test='DATE_ORDER == "asc"'>
						ORDER BY ORDER_DATE asc
					</if>	
				</if>
				<if test='ORDER_GUBUN == "MEMB_NM_ORDER"'>
					<if test='MEMB_NM_ORDER == "desc"'>
						ORDER BY MEMB_NM desc
					</if>	
					<if test='MEMB_NM_ORDER == "asc"'>
						ORDER BY MEMB_NM asc
					</if>
				</if>
			</if>
			<if test="ORDER_GUBUN == null or ORDER_GUBUN == ''">
				ORDER BY ORDER_DATE desc
			</if>
			
		<include refid="default.pagerFooter"/>
	</select>
	
	<!-- 리스트 카운트 -->
	<select id="deleteCount" parameterType="mall.web.domain.TB_ODINFOXM" resultType="int">
		SELECT COUNT(*)
		  FROM (
				SELECT A.ORDER_NUM    /*주문번호*/
				     , TO_CHAR(TO_DATE(ORDER_DATE,DECODE(LENGTH(ORDER_DATE),8,'YYYYMMDD','YYYYMMDDHH24MISS'))
		     								,DECODE(LENGTH(ORDER_DATE),8,'yyyy-MM-dd','yyyy-MM-dd HH24:mi:SS')) AS ORDER_DATE    /*주문일자*/
				     , A.MEMB_ID								  /*회원ID (주문자)*/
				     , POLARBEAR.FC_GET_MEMBID_NM(A.MEMB_ID) AS MEMB_NM     /*회원ID명(주문자)*/
				     , C.RECV_PERS    /*수령인*/
				     <!-- , B.PD_NAME      /*제품명*/ -->
				     , A.ORDER_AMT    /*주문금액*/
				     , A.ORDER_CON								        /*주문상태*/
				     , POLARBEAR.FC_GET_COMCOD_NM(A.ORDER_CON) AS ORDER_CON_NM    /*주문상태 명*/
				     , A.PAY_METD										/*결제수단*/
				     , POLARBEAR.FC_GET_COMCOD_NM(A.PAY_METD) AS PAY_METD_NM      /*결제수단 명*/
				  FROM POLARBEAR.TB_ODINFOXM A      /*주문정보 마스터*/
				 <!-- INNER JOIN TB_ODINFOXD B /*주문정보 상세*/
				    ON A.ORDER_NUM = B.ORDER_NUM -->
				 INNER JOIN POLARBEAR.TB_ODDLAIXM C /*주문배송지정보*/
				    ON A.ORDER_NUM = C.ORDER_NUM
				 WHERE DEL_YN = 'Y'
			    )
		<include refid="searchCondition"/>
	</select>
	
	<!-- 주문내역 삭제복원 -->
	<update id="deleteReturnOrdList" parameterType="java.util.List">
		UPDATE POLARBEAR.TB_ODINFOXM
		   SET DEL_YN = 'N',		/*삭제여부*/
		   	   MOD_DTM = SYSDATE,	/*수정날짜*/
		   	   MODP_ID =  #{MODP_ID}/*수정날짜*/
		 WHERE ORDER_NUM = #{ORDER_NUM}
		   AND ORDER_CON IN ('ORDER_CON_01','ORDER_CON_04','ORDER_CON_07')
	</update>
	
	<!-- 주문내역 상세삭제 복원-->
	<update id="deleteReturnOrdDtlList" parameterType="java.util.List">
		UPDATE POLARBEAR.TB_ODINFOXD
		   SET DEL_YN = 'N',		/*삭제여부*/
		       MOD_DTM = SYSDATE,	/*수정날짜*/
		       MODP_ID = #{MODP_ID}
		 WHERE ORDER_NUM = #{ORDER_NUM}
		   AND ORDER_CON IN ('ORDER_CON_01','ORDER_CON_04','ORDER_CON_07')
	</update>
	
	
	<!-- 엑셀전체리스트-->
	<select id="excelAllList" parameterType="mall.web.domain.TB_ODINFOXM" resultType="HashMap"><!-- 원래 : mall.web.domain.XTB_ODINFOXM -->
			SELECT *
			 FROM
			(
			  SELECT  ORDER_DATE    /*주문일자*/
			  			 , PAY_DTM		  /*결제일시*/
				         , ORDER_NUM    /*주문번호*/
				         , ORDER_CON
				         , MEM.MEMB_ID AS MEMB_ID
				      	 , TRIM(MEMB_NM) AS MEMB_NM     /*회원ID명(주문자)*/
					     , MEM.COM_NAME     /*(회사명)*/
					     , PD_NAME || DECODE(count,0,'',' 외 '||count||'종') AS PD_NAME /*주문상품*/
					     , ORDER_AMT
					     , DLVY_AMT
					     , ORDER_AMT - DLVY_AMT AS REAL_AMT 
					     , ORDER_CON_NM || DECODE(INFO.PAY_METD_NM,'','',DECODE(INFO.PAY_METD_NM,'','',' (' || INFO.PAY_METD_NM || ')')) AS ORDER_CON_NM
					     , DLAR_GUBN || ' ' || DLAR_DATE_TIME AS DLAR_GUBN
					     , DLVY_MSG
					     , INFO.ADM_REF
					     , PAY_METD		/*20190531_결제수단추가*/
			    FROM (
					SELECT A.ORDER_NUM
					     , TO_CHAR(TO_DATE(ORDER_DATE,DECODE(LENGTH(ORDER_DATE),8,'YYYYMMDD','YYYYMMDDHH24MISS'))
		     								,DECODE(LENGTH(ORDER_DATE),8,'yyyy-MM-dd','yyyy-MM-dd HH24:mi:SS')) AS ORDER_DATE    /*주문일자*/
					     , A.MEMB_ID
					     , (SELECT MEMB_NAME FROM POLARBEAR.TB_MBINFOXM WHERE MEMB_ID = A.MEMB_ID) AS MEMB_NM
					     , C.RECV_PERS
					     , (SELECT PD_NAME FROM POLARBEAR.TB_ODINFOXD WHERE ORDER_NUM = A.ORDER_NUM AND ROWNUM = 1) AS PD_NAME
					     , A.ORDER_AMT 
					     , A.ORDER_CON
					     , POLARBEAR.FC_GET_COMCOD_NM(A.ORDER_CON) AS ORDER_CON_NM 
					     , A.PAY_METD	
					     , POLARBEAR.FC_GET_COMCOD_NM(A.PAY_METD) AS PAY_METD_NM 
					     , (SELECT COUNT(*)-1 FROM POLARBEAR.TB_ODINFOXD WHERE ORDER_NUM = A.ORDER_NUM) AS count
					     , ORDER_DTM
					     , PAY_DTM	
					     , DECODE(DAP_YN,'Y',DLVY_AMT,'0') AS DLVY_AMT 
					     , DECODE(DLAR_GUBN,'DLAR_GUBN_05','현장출고','직배송요청') AS DLAR_GUBN 
					     , DECODE(DLVY_MSG,'',' ','있음') AS DLVY_MSG
			             , DECODE((SELECT ADM_REF 
					                      FROM POLARBEAR.TB_MBINFOXM MBINFO, POLARBEAR.TB_ODINFOXM ODINFO 
					                    WHERE MBINFO.MEMB_ID = ODINFO.MEMB_ID 
					                        AND ODINFO.ORDER_NUM = A.ORDER_NUM),'',' ','있음') AS ADM_REF  
                        <!-- , NVL(TO_CHAR(TO_DATE(C.DLAR_DATE,'YYYYMMDD'),'YYYY-MM-DD'),'')|| ' '||C.DLAR_TIME AS DLAR_DATE_TIME -->
                        ,DECODE(LENGTH(DLAR_DATE),8,TO_CHAR(TO_DATE(DLAR_DATE,'YYYYMMDD'),'YYYY-MM-DD'),'')|| ' '||DLAR_TIME AS DLAR_DATE_TIME   /*출고 시간*/
					  FROM POLARBEAR.TB_ODINFOXM A  
					 INNER JOIN POLARBEAR.TB_ODDLAIXM C /*주문배송지정보*/
					    ON A.ORDER_NUM = C.ORDER_NUM
					 WHERE DEL_YN IS NULL OR DEL_YN = 'N'
				    ) INFO
			        LEFT OUTER JOIN POLARBEAR.TB_MBINFOXM MEM
			        ON INFO.MEMB_ID = MEM.MEMB_ID
	        	)
				<include refid="searchCondition"/>
			<if test="ORDER_GUBUN != null and ORDER_GUBUN != ''">
				<if test='ORDER_GUBUN == "DATE_ORDER"'>
					<if test='DATE_ORDER == "desc"'>
						ORDER BY ORDER_DATE desc
					</if>	
					<if test='DATE_ORDER == "asc"'>
						ORDER BY ORDER_DATE asc
					</if>	
				</if>
				<if test='ORDER_GUBUN == "MEMB_NM_ORDER"'>
					<if test='MEMB_NM_ORDER == "desc"'>
						ORDER BY MEMB_NM desc
					</if>	
					<if test='MEMB_NM_ORDER == "asc"'>
						ORDER BY MEMB_NM asc
					</if>
				</if>
				<if test='ORDER_GUBUN == "COM_NAME_ORDER"'>
					<if test='MEMB_NM_ORDER == "desc"'>
						ORDER BY COM_NAME desc nulls last
					</if>	
					<if test='MEMB_NM_ORDER == "asc"'>
						ORDER BY COM_NAME asc
					</if>
				</if>
			</if>
			<if test="ORDER_GUBUN == null or ORDER_GUBUN == ''">
				ORDER BY ORDER_DATE desc
			</if>			
	</select>
	
	<update id="excelUpdate_Dlvy" parameterType="mall.web.domain.TB_ODINFOXD">
		UPDATE POLARBEAR.TB_ODINFOXD
		   SET MODP_ID = #{MODP_ID}
   	         , MOD_DTM = SYSDATE
	         , DLVY_COM = #{DLVY_COM} 
		     , DLVY_TDN = #{DLVY_TDN}
		     , ORDER_CON = 'ORDER_CON_05'
		     , DLVY_TDN_MODP_DATE = CASE WHEN DLVY_TDN = NULL AND #{DLVY_TDN} = NULL 
											THEN DLVY_TDN_MODP_DATE 
			                            WHEN DLVY_TDN != #{DLVY_TDN}
			                            	THEN SYSDATE
			                           	WHEN DLVY_TDN = #{DLVY_TDN}
			                           		THEN DLVY_TDN_MODP_DATE
			                            ELSE SYSDATE END
	     WHERE ORDER_NUM = TRIM(#{ORDER_NUM})
		   AND ORDER_DTNUM = TRIM(#{ORDER_DTNUM})
	</update>
	
	<update id="excelUpdate_Dlvy_mst_ordercon" parameterType="mall.web.domain.TB_ODINFOXD">
		UPDATE POLARBEAR.TB_ODINFOXM
		   SET ORDER_CON = 'ORDER_CON_05'
		     , DLVY_COM = #{DLVY_COM}
	     WHERE ORDER_NUM = TRIM(#{ORDER_NUM})
	</update>
	
	<!-- 운송장번호 조회 엑셀 -->
	<select id="getDlvyTdnlExcelList" parameterType="mall.web.domain.TB_ODINFOXD" resultType="HashMap">
		
		SELECT ORDER_NUM
		     , ORDER_DTNUM
		     , PD_CODE
		     , PD_NAME
		     , ORDER_QTY
		     , (SELECT RECV_PERS FROM POLARBEAR.TB_ODDLAIXM B WHERE B.ORDER_NUM = A.ORDER_NUM) ORDER_MEM_NM
		     , (SELECT BASC_ADDR || ' / ' || DTL_ADDR FROM POLARBEAR.TB_ODDLAIXM B WHERE B.ORDER_NUM = A.ORDER_NUM) ORDER_ADDR
		     , DLVY_COM
		     , DLVY_TDN
		     , (SELECT DLVY_MSG FROM POLARBEAR.TB_ODDLAIXM WHERE ORDER_NUM = A.ORDER_NUM) DLVY_MSG  
		     , (SELECT RECV_TELN FROM POLARBEAR.TB_ODDLAIXM WHERE ORDER_NUM = A.ORDER_NUM) RECV_TELN
		  FROM POLARBEAR.TB_ODINFOXD A
		 WHERE ORDER_NUM IN
		   	   <foreach item="item" index="index" collection="obj" open="(" separator="," close=")">
		   	   #{item}
		   	   </foreach>	
	</select>

	<!-- 결제전 상태의 외부 주문 처리 -->
	<update id="updateDatailQtyLink" parameterType="mall.web.domain.TB_ODINFOXD">
		UPDATE 
				POLARBEAR.TB_ODINFOXD
		   SET
		   		 ORDER_QTY = #{ORDER_QTY},		/*주문수량*/
		      	 ORDER_AMT = CASE
		       							WHEN PDDC_GUBN = 'PDDC_GUBN_02' THEN (PD_PRICE - PDDC_VAL) * #{ORDER_QTY}
				                        WHEN PDDC_GUBN = 'PDDC_GUBN_03' THEN (PD_PRICE - (PD_PRICE* PDDC_VAL/100))*#{ORDER_QTY}
				                        ELSE PD_PRICE *#{ORDER_QTY} 
									END,
			  	 MOD_DTM = SYSDATE,
			  	 MODP_ID = #{MODP_ID}
			   <choose>
			   		<when test = "ORDER_CON == 'ORDER_CON_02' or ORDER_CON == 'ORDER_CON_03' or ORDER_CON == 'ORDER_CON_05' or ORDER_CON == 'ORDER_CON_06' or ORDER_CON == 'ORDER_CON_07'">				
						, ORDER_CON = 'ORDER_CON_02'
					</when>				
					<otherwise>
				     	, ORDER_CON = #{ORDER_CON}
					</otherwise>				
			   </choose>			   
	   		 WHERE ORDER_NUM = #{ORDER_NUM}
	     	 AND ORDER_DTNUM = #{ORDER_DTNUM}
	     	 AND PD_CODE=#{PD_CODE}
	      <if test = "ORDER_CON != 'ORDER_CON_08'">	<!-- 구매완료 처리는 가능하도록 함 -->
		      AND LINK_ORDER_KEY IS NULL 	<!-- 오너클랜 주문 진행중이지 않을 경우만 수정 가능 -->
		      AND ORDER_CON = 'ORDER_CON_01'	<!-- 결제전의 주문만 변경가능 -->
	      </if>
	</update>
	
	<!-- 오너클랜 상품중 결제완료상태이나 오너클랜 주문이 생성되지 않은 상품의 수 -->
	<select id="getCntOrderOwnerclan" parameterType="String" resultType="int">
		SELECT count(*)
		  FROM POLARBEAR.TB_ODINFOXD
		 WHERE ORDER_NUM = #{value}
		   AND SUPR_ID = 'C00004'
		   <!-- AND ORDER_CON = 'ORDER_CON_02' -->
		   AND LINK_ORDER_KEY IS NULL	
	</select>
	
	<!-- 모든오피스 상품중 결제완료상태이나 오너클랜 주문이 생성되지 않은 상품의 수 -->
	<select id="getCntOrderModeoffice" parameterType="String" resultType="int">
		
		SELECT count(*)
		  FROM POLARBEAR.TB_ODINFOXD
		 WHERE ORDER_NUM = #{value}
		   AND SUPR_ID = 'C00006'
		   <!-- AND ORDER_CON = 'ORDER_CON_02' -->
		   AND LINK_ORDER_KEY IS NULL
	
	</select>
	
	<update id="setNullOwerclanOrdernum" parameterType="String">
		UPDATE POLARBEAR.TB_ODINFOXD 
		   SET LINK_ORDER_KEY = NULL
		     , LINK_MODP_DATE = NULL
		     , ORDER_CON = 'ORDER_CON_04'
		 WHERE SUPR_ID = 'C00004'
		   AND ORDER_NUM = #{value}
	</update>
	
		<!-- 주문상태 업데이트 -->
	<update id="orderPayUpdateDtl" parameterType="mall.web.domain.TB_ODINFOXM">
		 UPDATE
			POLARBEAR.TB_ODINFOXD
		SET
			  ORDER_CON = #{ORDER_CON}
			, MOD_DTM = SYSDATE
		<if test='MEMB_GUBN == "MEMB_GUBN_03" '>
		WHERE ORDER_NUM = #{ORDER_NUM}
		</if>
		<if test='MEMB_GUBN != "MEMB_GUBN_03" '>
		WHERE ORDER_NUM = #{ORDER_NUM}
		AND PD_CODE IN (SELECT A.PD_CODE FROM POLARBEAR.TB_ODINFOXD A 
							LEFT JOIN POLARBEAR.TB_PDINFOXM B 
							ON(A.PD_CODE = B.PD_CODE)
							WHERE ORDER_NUM = #{ORDER_NUM}
							AND B.SUPR_ID =#{LOGIN_SUPR_ID}) 
		</if>
	</update>
	
	
	<!-- 주문정보 엑셀 조회 -->
	<select id="getOrderExcelList" parameterType="mall.web.domain.TB_ODINFOXD" resultType="HashMap">
		SELECT TO_CHAR(TO_DATE(A.ORDER_DATE,DECODE(LENGTH(A.ORDER_DATE),8,'YYYYMMDD','YYYYMMDDHH24MISS'))
             , DECODE(LENGTH(A.ORDER_DATE),8,'yyyy-MM-dd','yyyy-MM-dd HH24:mi:SS')) AS ORDER_DATE
			 , TO_CHAR(PAY_DTM, 'YYYY-MM-DD HH24:mi:SS') PAY_DTM
             , NVL( (SELECT PD_BARCD FROM POLARBEAR.TB_PDINFOXM AA WHERE PD_CODE = B.PD_CODE), 'DELETED_PRODUCT') PD_BARCD
             , A.ORDER_NUM
             , B.PD_NAME
             , B.ORDER_QTY
             , B.PD_PRICE
             , DECODE(A.DAP_YN,'Y',A.DLVY_AMT,'0') AS DLVY_AMT
             , POLARBEAR.FC_GET_COMCOD_NM(A.PAY_METD) PAY_METD
             , B.ORDER_AMT --해당 상품의 총합계금액
             , POLARBEAR.FC_GET_COMCOD_NM(B.ORDER_CON) AS ORDER_CON_NM
             , C.DLVY_MSG
             , D.MEMB_NAME 
             , C.RECV_PERS
             , C.BASC_ADDR || ' / ' || C.DTL_ADDR ORDER_ADDR
             , NVL(D. MEMB_CPON, D.MEMB_TELN) MEMB_TEL
             , NVL(C.RECV_CPON, C.RECV_TELN) RECV_TEL
             , B.DLVY_TDN
             , TO_CHAR(B.DLVY_TDN_MODP_DATE, 'YYYY-MM-DD HH24:mi:SS') DLVY_TDN_MODP_DATE
             , (SELECT POLARBEAR.FC_GET_COMCOD_NM(PS_COM) FROM POLARBEAR.TB_SPINFOXM WHERE B.SUPR_ID=SUPR_ID) AS DLVY_COM_NAME
          FROM POLARBEAR.TB_ODINFOXM A
             , POLARBEAR.TB_ODINFOXD B
             , POLARBEAR.TB_ODDLAIXM C
             , POLARBEAR.TB_MBINFOXM D
         WHERE A.ORDER_NUM = B.ORDER_NUM
           AND A.ORDER_NUM = C.ORDER_NUM
           AND A.MEMB_ID = D.MEMB_ID
           AND A.ORDER_NUM IN
		   	   <foreach item="item" index="index" collection="obj" open="(" separator="," close=")">
		   	   #{item}
		   	   </foreach>
		<if test='MEMB_GUBN != "MEMB_GUBN_03" '>
		   	AND B.SUPR_ID=#{LOGIN_SUPR_ID}
		 </if> 
	</select>
	<select id="getDetailPg"  parameterType="mall.web.domain.TB_LGUPLUS">
		SELECT * FROM POLARBEAR.TB_LGUPLUS 
		WHERE LGD_OID =#{ORDER_CON}
		AND GUBUN ='ORDER'
	</select>
	
</mapper>
